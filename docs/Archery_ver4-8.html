<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Archery Score Keeper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Mobile Viewport Fixes */
        html {
            height: 100%;
            overflow: hidden; /* Prevent elastic scrolling on root */
        }
        body {
            /* Lock body to viewport to prevent iOS toolbar weirdness */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            overscroll-behavior-y: none;
            touch-action: manipulation;
            /* Safe area for iPhone X+ */
            padding-bottom: env(safe-area-inset-bottom); 
            background-color: #0f172a; /* slate-900 */
        }
        
        /* Raised Button Effect */
        .btn-raised {
            transition: all 0.1s;
            border-bottom-width: 4px;
            border-color: rgba(0,0,0,0.3);
            filter: brightness(100%);
        }
        .btn-raised:active {
            transform: translateY(2px);
            border-bottom-width: 0px;
            margin-bottom: 4px; /* Maintain layout height */
            filter: brightness(90%);
        }

        /* Animations */
        .animate-pop { animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Modal Transitions */
        .modal { transition: opacity 0.2s ease; }
        .modal-content { transition: transform 0.2s ease; }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .modal.hidden .modal-content { transform: scale(0.95); }

        /* Hide Scrollbar */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Form Elements */
        select, input { appearance: none; }

        /* Toggle Switch Styling */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10B981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10B981;
        }
    </style>
</head>
<body class="text-slate-100 flex flex-col font-sans">

    <!-- === Header === -->
    <header class="bg-slate-800 border-b border-slate-700 p-3 flex justify-between items-center z-10 shadow-md shrink-0 h-16">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-bullseye text-emerald-500 text-xl"></i>
            <div>
                <h1 class="font-bold text-lg tracking-wide leading-none">Archery<span class="text-emerald-500">Keeper</span></h1>
                <div class="text-[10px] text-slate-400 font-normal leading-none">by <span class="font-bold">Gary Hinshaw</span></div>
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="app.viewScoreCards()" class="text-slate-300 hover:text-white p-2" title="Scorecard">
                <i class="fa-solid fa-table-list text-xl"></i>
            </button>
            <button onclick="app.confirmReset()" class="text-slate-300 hover:text-red-400 p-2" title="Reset Round">
                <i class="fa-solid fa-rotate-right text-xl"></i>
            </button>
        </div>
    </header>

    <!-- === Main Content Area === -->
    <main id="main-container" class="flex-1 overflow-hidden relative w-full max-w-md mx-auto bg-slate-900 h-full">
        
        <!-- Screen 1: Setup -->
        <div id="setup-screen" class="h-full flex flex-col relative">
            <div class="flex-1 overflow-y-auto p-4 pb-48">
                <h2 class="text-xl font-bold mb-4 text-center text-emerald-400">Round Setup</h2>
                
                <!-- Round Type Selection -->
                <div class="mb-5 space-y-1 bg-slate-800/50 p-3 rounded-xl border border-emerald-900/50">
                    <label class="block text-sm font-bold text-emerald-400 uppercase tracking-wider mb-1">1. Select Round Type</label>
                    <select id="round-type" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-emerald-500 outline-none text-base font-bold" onchange="app.handleRoundTypeChange()">
                        <option value="" disabled selected>-- Please Select Round Type --</option>
                        <option value="ibo">3D / IBO (11-10-8-5-0)</option>
                        <option value="ifaa_300">IFAA 5-Spot 300 (5-4-3-2-1)</option>
                        <option value="ifaa_360">IFAA 5-Spot 360 (6-5-4-3-2-1)</option>
                        <option value="vegas_300">Vegas 3-Spot 300 (10-9..)</option>
                        <option value="vegas_330">Vegas 3-Spot 330 (11-10..)</option>
                    </select>
                </div>

                <!-- Target Count -->
                <div id="target-count-container" class="mb-5 space-y-1 hidden">
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Number of Targets</label>
                    <div class="flex items-center bg-slate-800 rounded-lg border border-slate-600 p-1">
                        <button onclick="document.getElementById('target-count').stepDown()" class="p-3 text-slate-400 hover:text-white"><i class="fa-solid fa-minus"></i></button>
                        <input type="number" id="target-count" value="30" class="bg-transparent text-center w-full outline-none font-mono text-lg" min="1" max="100">
                        <button onclick="document.getElementById('target-count').stepUp()" class="p-3 text-slate-400 hover:text-white"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>

                <!-- Add Shooter Section -->
                <div class="mb-4 bg-slate-800/50 p-4 rounded-xl border border-slate-700/50">
                    <label class="block text-sm font-bold text-emerald-400 uppercase tracking-wider mb-3">2. Add Shooter</label>
                    
                    <div class="space-y-4">
                        <!-- Name Only -->
                        <div>
                            <input type="text" id="new-shooter-name" placeholder="Name" autocapitalize="words" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white outline-none focus:border-emerald-500 text-sm">
                        </div>

                        <!-- Fun Class Toggle (More Visible) -->
                        <div class="flex items-center justify-between bg-slate-700/50 p-3 rounded-lg border border-slate-600">
                            <span class="text-sm font-bold text-white"><i class="fa-solid fa-face-smile text-yellow-400 mr-2"></i>Fun Class</span>
                            <div class="relative inline-block w-12 h-6 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="fun-class-toggle" id="fun-class-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-600 transition-all duration-300 left-0" onchange="app.toggleFunClass('class-selector-container', this.checked)"/>
                                <label for="fun-class-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-600 cursor-pointer"></label>
                            </div>
                        </div>

                        <!-- Class Selection Container -->
                        <div id="class-selector-container">
                            <div class="p-2 text-center text-slate-500 text-sm italic border border-dashed border-slate-600 rounded-lg">
                                Select Round Type above to see options
                            </div>
                        </div>

                        <button onclick="app.addShooter()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white p-3 rounded-lg font-bold shadow-lg active:scale-95 transition text-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-plus"></i> Add Shooter
                        </button>
                    </div>
                </div>
                    
                <!-- Shooter List -->
                <div id="shooter-list" class="space-y-2"></div>
            </div>

            <!-- Sticky Start Button -->
            <div class="absolute bottom-0 left-0 right-0 p-4 pb-24 bg-gradient-to-t from-slate-900 via-slate-900 to-transparent z-20">
                <button onclick="app.startRound()" class="w-full bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-bold py-3 rounded-xl text-lg shadow-xl shadow-emerald-900/30 active:scale-[0.98] transition">
                    START ROUND
                </button>
            </div>
        </div>

        <!-- Screen 2: Scoring -->
        <div id="scoring-screen" class="hidden h-full flex flex-col">
            
            <!-- Info Bar -->
            <div class="bg-slate-800/50 p-2 flex justify-between items-center text-xs sm:text-sm border-b border-slate-700 shrink-0 h-14">
                <span id="round-info-display" class="text-slate-400 truncate max-w-[150px]">IBO Round</span>
                <span class="font-bold text-emerald-400 bg-emerald-900/30 px-4 py-2 rounded-full whitespace-nowrap text-xl shadow-lg border border-emerald-500/30">
                    End <span id="current-end-display">1</span> / <span id="total-ends-display">20</span>
                </span>
            </div>

            <!-- Shooter Tabs -->
            <div class="flex overflow-x-auto whitespace-nowrap bg-slate-800 p-1 scrollbar-hide shrink-0 h-12 items-center" id="shooter-tabs"></div>

            <!-- Main Scoring Area -->
            <div class="flex-1 flex flex-col p-3 min-h-0">
                
                <!-- Score Display -->
                <div class="bg-slate-800 rounded-2xl p-3 mb-2 shadow-lg border border-slate-700 shrink-0">
                    <div class="flex justify-between items-end mb-1">
                        <div>
                            <div class="text-slate-400 text-[10px] uppercase tracking-widest">Total</div>
                            <div class="text-3xl font-black text-white leading-tight" id="running-total">0</div>
                        </div>
                        <div class="text-right">
                            <div class="text-slate-400 text-[10px] uppercase tracking-widest">This End</div>
                            <div class="text-2xl font-bold text-emerald-400 leading-tight" id="end-total">0</div>
                        </div>
                    </div>

                    <!-- Halves Display -->
                    <div class="flex justify-between text-xs text-slate-400 border-t border-slate-700/50 pt-2 pb-1">
                        <span>1st Half: <strong class="text-white text-sm" id="half1-total">0</strong></span>
                        <span>2nd Half: <strong class="text-white text-sm" id="half2-total">0</strong></span>
                    </div>
                    
                    <!-- Arrow slots -->
                    <div class="flex gap-1.5 mt-1 justify-center flex-wrap" id="arrow-slots"></div>
                </div>

                <!-- Controls (Bigger Buttons) -->
                <div class="flex justify-between items-center mb-2 px-1 shrink-0">
                    <button onclick="app.undoLastArrow()" class="bg-slate-700 hover:bg-slate-600 text-white border border-slate-500 px-6 h-14 rounded-xl font-bold shadow-md active:scale-95 transition text-lg flex items-center">
                        <i class="fa-solid fa-rotate-left mr-2"></i> Undo
                    </button>
                    <button onclick="app.nextShooterOrEnd()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 h-14 rounded-xl font-bold shadow-md active:scale-95 transition text-lg flex items-center">
                        Next <i class="fa-solid fa-chevron-right ml-2"></i>
                    </button>
                </div>

                <!-- Keypad -->
                <div id="keypad-container" class="flex-1 flex flex-col justify-center min-h-0 pb-safe">
                    <div class="grid gap-3 p-1" id="keypad"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- === Modals === -->

    <!-- Custom Notification Modal -->
    <div id="notification-modal" class="modal hidden fixed inset-0 z-[80] bg-black/80 flex items-center justify-center p-4">
        <div class="modal-content bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-600 text-center">
            <h4 class="text-2xl font-bold mb-4 text-emerald-400">ArcheryKeeper</h4>
            <p id="notification-message" class="text-white mb-8 text-xl font-medium leading-relaxed"></p>
            <button onclick="app.closeNotification()" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold text-lg shadow-lg">OK</button>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmation-modal" class="modal hidden fixed inset-0 z-[80] bg-black/80 flex items-center justify-center p-4">
        <div class="modal-content bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-600 text-center">
            <h4 class="text-xl font-bold mb-3 text-emerald-400">ArcheryKeeper</h4>
            <p id="confirmation-message" class="text-slate-300 mb-6 text-lg"></p>
            <div class="flex gap-3">
                <button onclick="app.closeConfirmation(false)" class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg font-bold">Cancel</button>
                <button onclick="app.closeConfirmation(true)" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold shadow-lg">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Scorecard Modal -->
    <div id="scorecard-modal" class="modal hidden fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-end sm:items-center justify-center">
        <div class="modal-content bg-slate-900 w-full sm:w-11/12 sm:max-w-xl h-[95dvh] sm:h-5/6 sm:rounded-2xl border-t sm:border border-slate-700 flex flex-col shadow-2xl">
            
            <!-- Modal Header -->
            <div class="p-3 border-b border-slate-700 flex justify-between items-center bg-slate-800 sm:rounded-t-2xl shrink-0">
                <h3 class="font-bold text-lg text-emerald-400">Scorecard</h3>
                <button onclick="app.closeScoreCard()" class="w-8 h-8 rounded-full bg-slate-700 text-slate-300 flex items-center justify-center">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-hidden flex flex-col">
                <div class="p-2 bg-slate-800/50 overflow-x-auto whitespace-nowrap shrink-0 border-b border-slate-700" id="modal-shooter-tabs"></div>
                
                <!-- Table -->
                <div class="flex-1 overflow-y-auto p-2">
                    <div id="scorecard-header-info" class="mb-2 p-2 bg-slate-800 rounded border border-slate-700 text-xs text-slate-300 flex justify-between items-center">
                        <!-- Filled by JS -->
                    </div>
                    <table class="w-full text-center border-collapse text-sm" id="scorecard-table">
                        <thead id="scorecard-head">
                            <!-- Filled by JS -->
                        </thead>
                        <tbody id="scorecard-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-3 pb-20 border-t border-slate-700 bg-slate-800 sm:rounded-b-2xl shrink-0 space-y-2">
                <div class="text-center text-xs text-slate-400 mb-1">Export Options</div>
                <div class="flex gap-2">
                    <button onclick="app.copyToClipboard()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg font-bold text-sm">
                        <i class="fa-regular fa-copy mr-2"></i> Copy
                    </button>
                    <button onclick="app.downloadCSV()" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-bold text-sm">
                        <i class="fa-solid fa-download mr-2"></i> CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Score Modal (Redesigned) -->
    <div id="edit-score-modal" class="modal hidden fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4">
        <div class="modal-content bg-slate-800 p-5 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-600 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-3">
                <h4 class="text-lg font-bold text-emerald-400">Correct Score</h4>
                <div class="text-sm text-slate-400" id="edit-score-context-header"></div>
            </div>
            
            <!-- Arrow Selection Row -->
            <div id="edit-arrows-row" class="flex gap-2 justify-center mb-4 bg-slate-700/50 p-3 rounded-xl overflow-x-auto">
                <!-- Injected via JS -->
            </div>

            <!-- Keypad -->
            <div class="flex-1 overflow-y-auto mb-4">
                <div class="grid grid-cols-3 gap-2" id="edit-keypad"></div>
            </div>

            <button onclick="app.saveEdits()" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold shadow-lg text-lg">Done</button>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal hidden fixed inset-0 z-[70] bg-black/80 flex items-center justify-center p-4">
        <div class="modal-content bg-slate-800 p-5 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-600">
            <h4 class="text-center text-lg font-bold mb-4 text-emerald-400">Edit Profile</h4>
            
            <div class="space-y-4 mb-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Name</label>
                    <input type="text" id="edit-profile-name" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white outline-none focus:border-emerald-500 text-sm" autocapitalize="words">
                </div>

                <!-- Fun Toggle -->
                <div class="flex items-center justify-between bg-slate-700/50 p-2 rounded-lg border border-slate-600">
                    <span class="text-sm font-bold text-white">Fun Class</span>
                    <div class="relative inline-block w-12 h-6 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="edit-fun-toggle" id="edit-fun-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-600 transition-all duration-300 left-0" onchange="app.toggleFunClass('edit-class-container', this.checked)"/>
                        <label for="edit-fun-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-600 cursor-pointer"></label>
                    </div>
                </div>

                <!-- Selectors Container -->
                <div id="edit-class-container">
                    <!-- Injected -->
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="app.closeEditProfile()" class="flex-1 py-3 bg-slate-700 rounded-lg text-slate-300 font-bold">Cancel</button>
                <button onclick="app.saveProfile()" class="flex-1 py-3 bg-emerald-600 text-white rounded-lg font-bold">Save</button>
            </div>
        </div>
    </div>

    <!-- Hidden textarea for legacy copy -->
    <textarea id="clipboard-target" class="fixed top-0 left-0 opacity-0 pointer-events-none"></textarea>

    <!-- Large Centered Toast (Moved to Top) -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-slate-800/95 border-2 border-emerald-500 text-white px-8 py-6 rounded-2xl shadow-2xl opacity-0 transition-all duration-300 pointer-events-none z-[90] text-center w-[90%] max-w-sm backdrop-blur-sm scale-90">
        <div id="toast-msg" class="text-2xl font-black tracking-wide text-emerald-400"></div>
    </div>

    <script>
        const app = {
            data: {
                shooters: [],
                roundType: 'ibo',
                targetCount: 30,
                arrowsPerEnd: 1,
                currentEnd: 1,
                currentShooterIndex: 0,
                active: false,
                editingProfileId: null,
                confirmCallback: null,
                notificationCallback: null,
                autoAdvanceTimer: null,
                roundCompleteTimer: null,
                transitionTimer: null, // Track 300ms alerts
                isTransitioning: false 
            },

            // --- Classes Data ---
            classes3D: [
                "Pee Wee (8 & under)", "Youth (9-12)", "Teen (13-17)",
                "Women's Barebow", "Women's Recurve", "Women's Longbow",
                "Men's Barebow", "Men's Recurve", "Men's Modern Recurve",
                "Men's Vintage Hunter", "Men's Modern Longbow", "Men's Longbow", "Men's Selfbow",
                "Senior"
            ],
            
            // Abbreviation Maps
            ageMap: {
                "Cub (<12)": "C", "Youth (12-14)": "Y", "Young Adult (15-17)": "Y/A",
                "Adult (18-49)": "A", "Senior (50-59)": "S", "Silver Senior (60-69)": "S/S",
                "Master Senior (70+)": "M/S", "Professional": "Pro", "Professional Senior": "Pro Senior"
            },
            genderMap: { "Male": "M", "Female": "F" },
            styleMap: {
                "Freestyle (FS)": "FS", "Bowhunter Freestyle (BHFS)": "BHFS",
                "Freestyle Limited Recurve (FSLR)": "FSLR", "Barebow Recurve (BBR)": "BB",
                "Traditional (Trad)": "TRAD", "Freestyle Limited (FSL)": "FSL",
                "Barebow (BB)": "BB", "Longbow": "LB", "Bowhunter (BH)": "BH",
                "Bowhunter Freestyle Limited (BHFSL)": "BHFSL", "Crossbow (CB)": "CB"
            },
            
            // Dropdown Arrays
            ifaaGenders: ["Male", "Female"],
            ifaaAges: ["Cub (<12)", "Youth (12-14)", "Young Adult (15-17)", "Adult (18-49)", "Senior (50-59)", "Silver Senior (60-69)", "Master Senior (70+)", "Professional", "Professional Senior"],
            ifaaStyles: ["Freestyle (FS)", "Bowhunter Freestyle (BHFS)", "Freestyle Limited Recurve (FSLR)", "Barebow Recurve (BBR)", "Traditional (Trad)", "Freestyle Limited (FSL)", "Barebow (BB)", "Longbow", "Bowhunter (BH)", "Bowhunter Freestyle Limited (BHFSL)", "Crossbow (CB)"],

            // --- Scoring Config ---
            configs: {
                ibo: { 
                    name: 'IBO 3D', arrows: 1, ends: 30, cols: 2,
                    keys: [
                        { label: '11', value: 11, color: 'bg-orange-500' }, 
                        { label: '10', value: 10, color: 'bg-yellow-500 text-black' }, 
                        { label: '8', value: 8, color: 'bg-red-600' }, 
                        { label: '5', value: 5, color: 'bg-blue-600' }, 
                        { label: '0', value: 0, color: 'bg-gray-500 text-white', span: 'col-span-2' } 
                    ]
                },
                ifaa_300: { 
                    name: 'IFAA 300', arrows: 5, ends: 12, cols: 3,
                    keys: [{ label: 'X', value: 5, display: 'X', color: 'bg-slate-100 text-slate-900 border-4 border-blue-800' }, { label: '5', value: 5, color: 'bg-slate-100 text-slate-900' }, { label: '4', value: 4, color: 'bg-blue-700' }, { label: '3', value: 3, color: 'bg-blue-700' }, { label: '2', value: 2, color: 'bg-blue-700' }, { label: '1', value: 1, color: 'bg-blue-700' }, { label: '0', value: 0, color: 'bg-gray-500 text-white', span: 'col-span-3' }]
                },
                ifaa_360: { 
                    name: 'IFAA 360', arrows: 5, ends: 12, cols: 3,
                    keys: [{ label: '6', value: 6, display: '6', color: 'bg-slate-100 text-slate-900 border-4 border-blue-800' }, { label: '5', value: 5, color: 'bg-slate-100 text-slate-900' }, { label: '4', value: 4, color: 'bg-blue-700' }, { label: '3', value: 3, color: 'bg-blue-700' }, { label: '2', value: 2, color: 'bg-blue-700' }, { label: '1', value: 1, color: 'bg-blue-700' }, { label: '0', value: 0, color: 'bg-gray-500 text-white', span: 'col-span-3' }]
                },
                vegas_300: { 
                    name: 'Vegas 300', arrows: 3, ends: 10, cols: 3,
                    keys: [{ label: 'X', value: 10, display: 'X', color: 'bg-yellow-400 text-black border-2 border-black' }, { label: '10', value: 10, color: 'bg-yellow-400 text-black' }, { label: '9', value: 9, color: 'bg-yellow-400 text-black' }, { label: '8', value: 8, color: 'bg-red-600' }, { label: '7', value: 7, color: 'bg-red-600' }, { label: '6', value: 6, color: 'bg-blue-600' }, { label: '5', value: 5, color: 'bg-blue-600' }, { label: '4', value: 4, color: 'bg-slate-900 border border-slate-600' }, { label: '3', value: 3, color: 'bg-slate-900 border border-slate-600' }, { label: '2', value: 2, color: 'bg-slate-100 text-slate-900' }, { label: '1', value: 1, color: 'bg-slate-100 text-slate-900' }, { label: 'M', value: 0, color: 'bg-gray-500 text-white' }]
                },
                vegas_330: { 
                    name: 'Vegas 330', arrows: 3, ends: 10, cols: 3,
                    keys: [{ label: '11', value: 11, display: '11', color: 'bg-yellow-400 text-black border-2 border-black' }, { label: '10', value: 10, color: 'bg-yellow-400 text-black' }, { label: '9', value: 9, color: 'bg-yellow-400 text-black' }, { label: '8', value: 8, color: 'bg-red-600' }, { label: '7', value: 7, color: 'bg-red-600' }, { label: '6', value: 6, color: 'bg-blue-600' }, { label: '5', value: 5, color: 'bg-blue-600' }, { label: '4', value: 4, color: 'bg-slate-900 border border-slate-600' }, { label: '3', value: 3, color: 'bg-slate-900 border border-slate-600' }, { label: '2', value: 2, color: 'bg-slate-100 text-slate-900' }, { label: '1', value: 1, color: 'bg-slate-100 text-slate-900' }, { label: 'M', value: 0, color: 'bg-gray-500 text-white' }]
                }
            },

            init() {
                const saved = localStorage.getItem('archeryState_v9');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed.active) {
                            this.data = parsed;
                            this.showScreen('scoring');
                            this.renderScoringUI();
                            return;
                        }
                    } catch (e) { console.error("Save corrupted"); }
                }
                this.showScreen('setup');
                this.handleRoundTypeChange(); // Ensure initial state handles empty selection
            },

            save() { localStorage.setItem('archeryState_v9', JSON.stringify(this.data)); },

            // Format Name Helper
            formatName(str) {
                return str.toLowerCase().replace(/(?:^|[\s-])\w/g, function(match) { return match.toUpperCase(); });
            },

            // --- Custom Modals ---
            showAlert(msg, callback) {
                document.getElementById('notification-message').innerHTML = msg; 
                this.notificationCallback = callback;
                document.getElementById('notification-modal').classList.remove('hidden');
            },
            closeNotification() {
                document.getElementById('notification-modal').classList.add('hidden');
                if (this.notificationCallback) {
                    this.notificationCallback();
                    this.notificationCallback = null;
                }
            },
            showConfirm(msg, callback) {
                document.getElementById('confirmation-message').textContent = msg;
                this.confirmCallback = callback;
                document.getElementById('confirmation-modal').classList.remove('hidden');
            },
            closeConfirmation(result) {
                document.getElementById('confirmation-modal').classList.add('hidden');
                if (this.confirmCallback) this.confirmCallback(result);
                this.confirmCallback = null;
            },

            showScreen(screenId) {
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('scoring-screen').classList.add('hidden');
                document.getElementById(screenId + '-screen').classList.remove('hidden');
            },

            handleRoundTypeChange() {
                const type = document.getElementById('round-type').value;
                const targetCountDiv = document.getElementById('target-count-container');
                const classContainer = document.getElementById('class-selector-container');
                
                if (!type) {
                    targetCountDiv.classList.add('hidden');
                    classContainer.innerHTML = `<div class="p-2 text-center text-slate-500 text-sm italic border border-dashed border-slate-600 rounded-lg">Select Round Type above to see options</div>`;
                    return;
                }

                targetCountDiv.classList.toggle('hidden', type !== 'ibo');
                
                // Render selectors for Add Shooter
                this.renderClassSelectors('class-selector-container', type);
            },

            renderClassSelectors(containerId, type) {
                const container = document.getElementById(containerId);
                // Return if container doesn't exist (safety)
                if (!container) return;
                
                // If type is empty, we don't render selectors
                if (!type) return;

                const isFun = document.getElementById(containerId === 'class-selector-container' ? 'fun-class-toggle' : 'edit-fun-toggle')?.checked;
                
                let html = '';
                if (type === 'ibo') {
                    html = `
                        <select class="class-input w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-white text-sm outline-none focus:border-emerald-500" ${isFun ? 'disabled' : ''}>
                            <option value="">Select Class...</option>
                            ${this.classes3D.map(c => `<option value="${c}">${c}</option>`).join('')}
                        </select>
                    `;
                } else {
                    html = `
                        <div class="grid grid-cols-1 gap-2">
                            <select id="${containerId}-gender" class="class-input bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-white text-sm outline-none focus:border-emerald-500" ${isFun ? 'disabled' : ''}>
                                <option value="">Gender...</option>
                                ${this.ifaaGenders.map(g => `<option value="${g}">${g}</option>`).join('')}
                            </select>
                            <select id="${containerId}-age" class="class-input bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-white text-sm outline-none focus:border-emerald-500" ${isFun ? 'disabled' : ''}>
                                <option value="">Age Group...</option>
                                ${this.ifaaAges.map(a => `<option value="${a}">${a}</option>`).join('')}
                            </select>
                            <select id="${containerId}-style" class="class-input bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-white text-sm outline-none focus:border-emerald-500" ${isFun ? 'disabled' : ''}>
                                <option value="">Style...</option>
                                ${this.ifaaStyles.map(s => `<option value="${s}">${s}</option>`).join('')}
                            </select>
                        </div>
                    `;
                }
                container.innerHTML = html;
                
                // If checking "Fun", clear visual validation
                if (isFun) {
                    container.querySelectorAll('select').forEach(el => el.classList.add('opacity-50'));
                }
            },

            toggleFunClass(containerId, isChecked) {
                let type;
                if (containerId === 'class-selector-container') {
                    type = document.getElementById('round-type').value;
                } else {
                    type = this.data.roundType;
                }
                this.renderClassSelectors(containerId, type);
            },

            addShooter() {
                const nameInput = document.getElementById('new-shooter-name');
                const name = this.formatName(nameInput.value.trim()); // Capitalize name
                const isFun = document.getElementById('fun-class-toggle').checked;
                const type = document.getElementById('round-type').value;

                if (!type) return this.showAlert("Please select a Round Type first.");
                if (!name) return this.showAlert("Please enter a name");

                let shooterClass = "Fun Class";
                let shooterCode = "FUN";
                let parts = { isFun };

                if (!isFun) {
                    if (type === 'ibo') {
                        const sel = document.querySelector('#class-selector-container select');
                        if (!sel || !sel.value) return this.showAlert("Please select a class or toggle 'Fun Class'");
                        shooterClass = sel.value;
                        shooterCode = sel.value;
                        parts.selection = sel.value;
                    } else {
                        const g = document.getElementById('class-selector-container-gender').value;
                        const a = document.getElementById('class-selector-container-age').value;
                        const s = document.getElementById('class-selector-container-style').value;
                        
                        if (!g || !a || !s) return this.showAlert("Please select Age, Gender, and Style, or toggle 'Fun Class'");
                        
                        shooterClass = `${a} ${g} ${s}`;
                        shooterCode = `${this.ageMap[a]}-${this.genderMap[g]}-${this.styleMap[s]}`;
                        parts = { isFun: false, gender: g, age: a, style: s };
                    }
                }

                this.data.shooters.push({ 
                    id: Date.now(), 
                    name, 
                    class: shooterClass,
                    classCode: shooterCode,
                    classParts: parts,
                    scores: [] 
                });
                
                // Reset Fields
                nameInput.value = '';
                
                // Reset Fun Toggle
                const funToggle = document.getElementById('fun-class-toggle');
                funToggle.checked = false;
                
                // Reset Dropdowns
                if (type === 'ibo') {
                    const sel = document.querySelector('#class-selector-container select');
                    if (sel) sel.value = "";
                } else {
                    const g = document.getElementById('class-selector-container-gender');
                    const a = document.getElementById('class-selector-container-age');
                    const s = document.getElementById('class-selector-container-style');
                    if (g) g.value = "";
                    if (a) a.value = "";
                    if (s) s.value = "";
                }
                
                // Update UI state (enable dropdowns)
                this.toggleFunClass('class-selector-container', false);
                
                this.renderShooterList();
            },

            // --- Edit Profile ---

            openEditProfile(index) {
                this.editingProfileIndex = index;
                const shooter = this.data.shooters[index];
                
                // Populate Modal
                document.getElementById('edit-profile-name').value = shooter.name;
                const funToggle = document.getElementById('edit-fun-toggle');
                funToggle.checked = shooter.classParts?.isFun || false;
                
                // Render Selectors for Edit
                this.renderClassSelectors('edit-class-container', this.data.roundType);
                
                // Set Values if not Fun
                if (!funToggle.checked && shooter.classParts) {
                    if (this.data.roundType === 'ibo') {
                        const sel = document.querySelector('#edit-class-container select');
                        if(sel) sel.value = shooter.classParts.selection || "";
                    } else {
                        const g = document.getElementById('edit-class-container-gender');
                        const a = document.getElementById('edit-class-container-age');
                        const s = document.getElementById('edit-class-container-style');
                        if(g) g.value = shooter.classParts.gender || "";
                        if(a) a.value = shooter.classParts.age || "";
                        if(s) s.value = shooter.classParts.style || "";
                    }
                }

                document.getElementById('edit-profile-modal').classList.remove('hidden');
            },

            saveProfile() {
                const idx = this.editingProfileIndex;
                const name = this.formatName(document.getElementById('edit-profile-name').value.trim()); // Capitalize
                const isFun = document.getElementById('edit-fun-toggle').checked;
                
                if (!name) return this.showAlert("Name required");

                const type = this.data.roundType;
                let shooterClass = "Fun Class";
                let shooterCode = "FUN";
                let parts = { isFun };

                if (!isFun) {
                    if (type === 'ibo') {
                        const sel = document.querySelector('#edit-class-container select');
                        if (!sel.value) return this.showAlert("Select a class or choose Fun");
                        shooterClass = sel.value;
                        shooterCode = sel.value;
                        parts.selection = sel.value;
                    } else {
                        const g = document.getElementById('edit-class-container-gender').value;
                        const a = document.getElementById('edit-class-container-age').value;
                        const s = document.getElementById('edit-class-container-style').value;
                        if (!g || !a || !s) return this.showAlert("Select all options or choose Fun");
                        shooterClass = `${a} ${g} ${s}`;
                        shooterCode = `${this.ageMap[a]}-${this.genderMap[g]}-${this.styleMap[s]}`;
                        parts = { isFun: false, gender: g, age: a, style: s };
                    }
                }

                // Update Shooter
                this.data.shooters[idx].name = name;
                this.data.shooters[idx].class = shooterClass;
                this.data.shooters[idx].classCode = shooterCode;
                this.data.shooters[idx].classParts = parts;

                this.save();
                this.closeEditProfile();
                this.renderShooterList(); // In setup
                this.renderScoringUI(); // In game
                
                // If scorecard modal is open, refresh it
                if (!document.getElementById('scorecard-modal').classList.contains('hidden')) {
                    this.renderScoreCardTable(idx);
                }
            },

            closeEditProfile() { document.getElementById('edit-profile-modal').classList.add('hidden'); },

            removeShooter(index) {
                this.data.shooters.splice(index, 1);
                this.renderShooterList();
            },

            renderShooterList() {
                const list = document.getElementById('shooter-list');
                list.innerHTML = this.data.shooters.map((s, i) => `
                    <div class="flex items-center justify-between bg-slate-800 p-3 rounded-lg border border-slate-700 animate-pop">
                        <div class="flex-1 min-w-0 mr-2">
                            <div class="font-bold text-sm truncate">${s.name}</div>
                            <div class="text-xs text-slate-400 truncate">${s.classCode}</div>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="app.openEditProfile(${i})" class="text-slate-400 hover:text-white p-2 shrink-0"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button onclick="app.removeShooter(${i})" class="text-red-400 hover:text-red-300 p-2 shrink-0"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
            },

            confirmReset() {
                this.showConfirm("Reset current round? Data will be lost.", (yes) => {
                    if (yes) {
                        localStorage.removeItem('archeryState_v9'); // Fixed key
                        location.reload();
                    }
                });
            },

            startRound() {
                if (this.data.shooters.length === 0) return this.showAlert("Add a shooter first.");
                const type = document.getElementById('round-type').value;
                if (!type) return this.showAlert("Please select a Round Type.");

                const config = this.configs[type];
                this.data.roundType = type;
                this.data.arrowsPerEnd = config.arrows;
                this.data.targetCount = type === 'ibo' ? (parseInt(document.getElementById('target-count').value) || 30) : config.ends;
                
                this.data.shooters.forEach(s => s.scores = Array(this.data.targetCount).fill(null).map(() => []));
                this.data.currentEnd = 1;
                this.data.currentShooterIndex = 0;
                this.data.active = true;
                this.save();
                this.showScreen('scoring');
                this.renderScoringUI();
            },

            renderScoringUI() {
                const config = this.configs[this.data.roundType];
                const shooter = this.data.shooters[this.data.currentShooterIndex];

                document.getElementById('round-info-display').textContent = config.name;
                document.getElementById('current-end-display').textContent = this.data.currentEnd;
                document.getElementById('total-ends-display').textContent = this.data.targetCount;

                const tabs = document.getElementById('shooter-tabs');
                tabs.innerHTML = this.data.shooters.map((s, i) => `
                    <button onclick="app.switchShooter(${i})" class="${i === this.data.currentShooterIndex ? 'bg-emerald-600 text-white shadow-md' : 'bg-slate-700 text-slate-400'} px-4 py-2 rounded-lg mr-2 font-bold text-sm min-w-[100px] transition truncate max-w-[150px]">${s.name}</button>
                `).join('');
                setTimeout(() => tabs.children[this.data.currentShooterIndex]?.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }), 50);

                const currentScores = shooter.scores[this.data.currentEnd - 1] || [];
                const endTotal = currentScores.reduce((sum, a) => sum + a.value, 0);
                let runningTotal = 0;
                let half1Total = 0;
                let half2Total = 0;
                
                const halfEnds = Math.ceil(this.data.targetCount / 2);

                shooter.scores.forEach((endArr, idx) => { 
                    if (endArr) {
                        const s = endArr.reduce((s, a) => s + a.value, 0);
                        runningTotal += s; 
                        if (idx < halfEnds) half1Total += s;
                        else half2Total += s;
                    }
                });

                document.getElementById('end-total').textContent = endTotal;
                document.getElementById('running-total').textContent = runningTotal;
                document.getElementById('half1-total').textContent = half1Total;
                document.getElementById('half2-total').textContent = half2Total;

                const slots = document.getElementById('arrow-slots');
                let slotsHtml = '';
                for (let i = 0; i < this.data.arrowsPerEnd; i++) {
                    const arrow = currentScores[i];
                    slotsHtml += arrow 
                        ? `<div class="w-10 h-10 flex items-center justify-center rounded-full text-sm font-bold shadow-inner ${arrow.color} animate-pop border border-slate-700">${arrow.display || arrow.value}</div>`
                        : `<div class="w-10 h-10 rounded-full border border-dashed border-slate-600 bg-slate-800/50"></div>`;
                }
                slots.innerHTML = slotsHtml;

                const keypad = document.getElementById('keypad');
                // Apply dynamic grid columns (2 for 3D, 3 for others)
                keypad.className = `grid gap-3 p-1 pb-4 grid-cols-${config.cols || 3}`;
                
                keypad.innerHTML = config.keys.map(k => `
                    <button onclick='app.addScore(${JSON.stringify(k)})' class="btn-raised ${k.color} ${k.span || ''} h-20 rounded-2xl text-2xl font-black shadow-lg flex items-center justify-center relative overflow-hidden active:scale-95 transition-transform duration-75">
                        ${k.label}
                    </button>
                `).join('');
            },

            addScore(keyObj) {
                const shooter = this.data.shooters[this.data.currentShooterIndex];
                const endIdx = this.data.currentEnd - 1;
                
                // Initialize array if needed
                if (!shooter.scores[endIdx]) shooter.scores[endIdx] = [];
                
                if (shooter.scores[endIdx].length < this.data.arrowsPerEnd) {
                    shooter.scores[endIdx].push({ value: keyObj.value, display: keyObj.display || keyObj.label, color: keyObj.color });
                    this.save();
                    this.renderScoringUI();

                    // Check End Completion
                    const isLastShooter = this.data.currentShooterIndex === this.data.shooters.length - 1;
                    const isEndComplete = shooter.scores[endIdx].length === this.data.arrowsPerEnd;
                    
                    if (isLastShooter && isEndComplete) {
                        const halfEnds = Math.ceil(this.data.targetCount / 2);
                        
                        // Check halfway point, but SKIP for IBO rounds
                        if (this.data.currentEnd === halfEnds && this.data.roundType !== 'ibo') {
                            // Halfway Alert (Modified text and size)
                            this.data.transitionTimer = setTimeout(() => {
                                this.data.transitionTimer = null;
                                this.showAlert("<span class='text-3xl font-bold leading-relaxed'>First half of round is complete.</span>", () => {
                                    this.nextShooterOrEnd(); 
                                });
                            }, 300);
                        } else if (this.data.currentEnd === this.data.targetCount) {
                             // Final End Alert - Wait 2s
                             this.data.roundCompleteTimer = setTimeout(() => {
                                this.data.roundCompleteTimer = null;
                                this.showAlert("Round Complete!", () => {
                                    this.viewScoreCards();
                                });
                            }, 2000);
                        } else {
                            // Normal End (or IBO Halftime) - Auto Advance 5s via Large Toast
                            this.showToast(`End ${this.data.currentEnd} Complete.<br>Advancing...`);
                            this.data.autoAdvanceTimer = setTimeout(() => {
                                this.data.autoAdvanceTimer = null;
                                this.hideToast();
                                this.nextShooterOrEnd();
                            }, 5000);
                        }
                    }
                }
            },

            undoLastArrow() {
                const shooter = this.data.shooters[this.data.currentShooterIndex];
                const endIdx = this.data.currentEnd - 1;
                if (shooter.scores[endIdx] && shooter.scores[endIdx].length > 0) {
                    shooter.scores[endIdx].pop();
                    this.save();
                    this.renderScoringUI();
                }
            },

            switchShooter(index) {
                this.data.currentShooterIndex = index;
                this.renderScoringUI();
            },

            nextShooterOrEnd() {
                // Prevent double submissions
                if (this.data.isTransitioning) return;

                // Cancel any pending alerts/timers to prevent conflict
                if (this.data.transitionTimer) {
                    clearTimeout(this.data.transitionTimer);
                    this.data.transitionTimer = null;
                }
                if (this.data.autoAdvanceTimer) {
                    clearTimeout(this.data.autoAdvanceTimer);
                    this.data.autoAdvanceTimer = null;
                    this.hideToast(); 
                }
                if (this.data.roundCompleteTimer) {
                    clearTimeout(this.data.roundCompleteTimer);
                    this.data.roundCompleteTimer = null;
                    this.showAlert("Round Complete!", () => {
                        this.viewScoreCards();
                    });
                    return;
                }

                const currentShooter = this.data.shooters[this.data.currentShooterIndex];
                const endIdx = this.data.currentEnd - 1;
                
                // Validate current shooter finished
                if (currentShooter.scores[endIdx].length < this.data.arrowsPerEnd) {
                    return this.showAlert("Finish shooting this end first.");
                }
                
                // Set transition lock
                this.data.isTransitioning = true;
                setTimeout(() => { this.data.isTransitioning = false; }, 500); // 0.5s cooldown

                if (this.data.currentShooterIndex < this.data.shooters.length - 1) {
                    this.data.currentShooterIndex++;
                } else {
                    if (this.data.currentEnd < this.data.targetCount) {
                        this.data.currentEnd++;
                        this.data.currentShooterIndex = 0;
                    } else {
                        this.viewScoreCards();
                        return;
                    }
                }
                this.save();
                this.renderScoringUI();
            },

            viewScoreCards() {
                if (!this.data.active) return;
                const modalTabs = document.getElementById('modal-shooter-tabs');
                modalTabs.innerHTML = this.data.shooters.map((s, i) => `
                    <button onclick="app.renderScoreCardTable(${i})" class="modal-tab-btn px-4 py-2 mr-2 rounded-full text-xs font-bold border ${i === this.data.currentShooterIndex ? 'border-emerald-500 bg-emerald-600 text-white' : 'border-slate-600 bg-slate-700 text-slate-300'}">${s.name}</button>
                `).join('');
                this.renderScoreCardTable(this.data.currentShooterIndex);
                document.getElementById('scorecard-modal').classList.remove('hidden');
            },

            // Helper to sort arrows High to Low
            sortArrows(a, b) {
                // If values differ, higher value first
                if (a.value !== b.value) return b.value - a.value;
                // If values same, X comes first
                if (a.display === 'X' && b.display !== 'X') return -1;
                if (b.display === 'X' && a.display !== 'X') return 1;
                return 0;
            },

            renderScoreCardTable(shooterIdx) {
                const shooter = this.data.shooters[shooterIdx];
                const tbody = document.getElementById('scorecard-body');
                const thead = document.getElementById('scorecard-head');
                const headerInfo = document.getElementById('scorecard-header-info');
                const type = this.data.roundType;
                
                // Header Info with Edit Button
                headerInfo.innerHTML = `
                    <div>
                        <div class="font-bold text-sm text-emerald-400">${shooter.name}</div>
                        <div class="text-xs">Class: ${shooter.classCode || shooter.class}</div>
                    </div>
                    <button onclick="app.openEditProfile(${shooterIdx})" class="p-2 text-slate-400 hover:text-white"><i class="fa-solid fa-pen-to-square"></i></button>
                `;

                // Set Dynamic Headers & Count Logic Identifiers
                let stat1Label = "X";
                let stat2Label = "";
                let hasStat2 = false;

                // Specific Round Logic
                if (type === 'vegas_330') {
                    stat1Label = "11";
                    stat2Label = "10";
                    hasStat2 = true;
                } else if (type === 'ifaa_360') {
                    stat1Label = "6";
                    stat2Label = "5";
                    hasStat2 = true;
                } else if (type === 'ibo') {
                    stat1Label = "11"; 
                    // 10s removed for IBO
                    hasStat2 = false;
                } else if (type.includes('vegas')) { // Standard Vegas 300
                    stat1Label = "X";
                    stat2Label = "10";
                    hasStat2 = true;
                } else if (type.includes('ifaa')) { // Standard IFAA 300
                    stat1Label = "X";
                    stat2Label = "5";
                    hasStat2 = true;
                }

                // Build Table Header
                let headerHtml = `
                    <tr class="text-slate-400 text-xs uppercase bg-slate-800 sticky top-0 z-10 shadow-sm">
                        <th class="p-2">End</th>
                        <th class="p-2">Arrows</th>
                        <th class="p-2">Score</th>
                        <th class="p-2">${stat1Label}</th>
                        ${hasStat2 ? `<th class="p-2">${stat2Label}</th>` : ''}
                        <th class="p-2">Run</th>
                    </tr>
                `;
                thead.innerHTML = headerHtml;

                let runningTotal = 0;
                let half1Total = 0;
                let half2Total = 0;
                let grandStat1 = 0;
                let grandStat2 = 0;
                
                let html = '';
                const halfEnds = Math.ceil(this.data.targetCount / 2);
                const colSpan = hasStat2 ? 6 : 5;

                document.querySelectorAll('.modal-tab-btn').forEach((btn, i) => {
                    if(i===shooterIdx) btn.className = "modal-tab-btn px-4 py-2 mr-2 rounded-full text-xs font-bold border border-emerald-500 bg-emerald-600 text-white";
                    else btn.className = "modal-tab-btn px-4 py-2 mr-2 rounded-full text-xs font-bold border border-slate-600 bg-slate-700 text-slate-300";
                });

                for (let i = 0; i < this.data.targetCount; i++) {
                    const arrows = shooter.scores[i] || [];
                    const endSum = arrows.reduce((a, b) => a + b.value, 0);
                    
                    let endStat1 = 0;
                    let endStat2 = 0;

                    if (arrows.length > 0) {
                        runningTotal += endSum;
                        if (i < halfEnds) half1Total += endSum;
                        else half2Total += endSum;
                        
                        // Count Stats Logic
                        arrows.forEach(a => {
                            const val = a.value;
                            const disp = a.display;

                            if (type === 'vegas_330') {
                                if (val === 11) endStat1++;
                                else if (val === 10) endStat2++;
                            } else if (type === 'ifaa_360') {
                                if (val === 6) endStat1++;
                                else if (val === 5) endStat2++;
                            } else if (type === 'ibo') {
                                // IBO - Count 11s
                                if (val === 11) endStat1++;
                            } else if (type.includes('vegas')) {
                                if (disp === 'X') endStat1++;
                                else if (val === 10) endStat2++;
                            } else if (type.includes('ifaa')) { // 300
                                if (disp === 'X') endStat1++;
                                else if (val === 5) endStat2++;
                            }
                        });
                        grandStat1 += endStat1;
                        grandStat2 += endStat2;
                    }
                    
                    // Sort arrows for display
                    const sortedArrows = [...arrows].sort(this.sortArrows);

                    let arrowCells = '';
                    for (let j = 0; j < this.data.arrowsPerEnd; j++) {
                        if (sortedArrows[j]) {
                            const originalIdx = arrows.indexOf(sortedArrows[j]);
                            arrowCells += `<span onclick="app.openEditModal(${shooterIdx}, ${i}, ${originalIdx})" class="inline-block w-6 h-6 leading-6 text-center rounded-full ${sortedArrows[j].color} text-[10px] font-bold mx-0.5 shadow-sm border border-black/20">${sortedArrows[j].display || sortedArrows[j].value}</span>`;
                        } else {
                            arrowCells += `<span class="inline-block w-6 h-6 leading-6 text-center rounded-full bg-slate-900 text-slate-600 text-[10px] mx-0.5">-</span>`;
                        }
                    }
                    html += `<tr class="border-b border-slate-700 ${i % 2 === 0 ? 'bg-slate-800' : 'bg-slate-800/50'}">
                        <td class="p-2 text-slate-400 font-mono">${i + 1}</td>
                        <td class="p-2 whitespace-nowrap">${arrowCells}</td>
                        <td class="p-2 text-emerald-400 font-bold">${arrows.length ? endSum : '-'}</td>
                        <td class="p-2 text-xs font-bold text-slate-300">${endStat1 || '-'}</td>
                        ${hasStat2 ? `<td class="p-2 text-xs font-bold text-slate-300">${endStat2 || '-'}</td>` : ''}
                        <td class="p-2 font-bold">${arrows.length ? runningTotal : '-'}</td>
                    </tr>`;

                    if (i === halfEnds - 1) {
                         html += `<tr class="bg-slate-700 border-y-2 border-slate-600"><td colspan="2" class="p-2 text-right text-slate-300 text-xs font-bold uppercase">1st Half Total</td><td colspan="${colSpan-2}" class="p-2 text-lg font-bold text-white text-right">${half1Total}</td></tr>`;
                    }
                }
                
                html += `<tr class="bg-slate-700 border-b border-slate-600"><td colspan="2" class="p-2 text-right text-slate-300 text-xs font-bold uppercase">2nd Half Total</td><td colspan="${colSpan-2}" class="p-2 text-lg font-bold text-white text-right">${half2Total}</td></tr>`;
                
                // Footer
                let footerStats = '';
                if (hasStat2) {
                     footerStats = `${stat1Label}s: ${grandStat1} | ${stat2Label}s: ${grandStat2}`;
                } else {
                    footerStats = `${stat1Label}s: ${grandStat1}`;
                }

                html += `
                    <tr class="bg-slate-900 border-t-2 border-emerald-600">
                        <td colspan="3" class="p-3 text-left pl-4">
                            <span class="text-slate-400 text-xs font-bold uppercase mr-2">Stats</span>
                            <span class="text-md font-bold text-white">${footerStats}</span>
                        </td>
                        <td colspan="${colSpan-3}" class="p-3 text-right">
                            <span class="text-emerald-500 text-xs font-bold uppercase mr-2">Total</span>
                            <span class="text-2xl font-black text-white">${runningTotal}</span>
                        </td>
                    </tr>`;
                
                tbody.innerHTML = html;
            },

            closeScoreCard() { document.getElementById('scorecard-modal').classList.add('hidden'); },

            openEditModal(shooterIdx, endIdx, arrowIdx) {
                // Initial Setup
                this.editingCtx = { shooterIdx, endIdx, currentArrowIdx: arrowIdx, tempScores: [] };
                const shooter = this.data.shooters[shooterIdx];
                
                // Copy existing scores to temp array
                const existing = shooter.scores[endIdx] || [];
                this.editingCtx.tempScores = Array.from({length: this.data.arrowsPerEnd}, (_, i) => existing[i] || null);

                const config = this.configs[this.data.roundType];
                const contextDiv = document.getElementById('edit-score-context-header');
                
                contextDiv.innerHTML = `${shooter.name} - End ${endIdx + 1}`;

                // Render Arrows Row
                this.renderEditArrowsRow();

                // Render Keypad
                document.getElementById('edit-keypad').innerHTML = config.keys.map(k => `
                    <button onclick='app.applyEdit(${JSON.stringify(k)})' class="btn-raised ${k.color} h-12 rounded-lg text-lg font-bold shadow-md">${k.label}</button>
                `).join('');

                document.getElementById('edit-score-modal').classList.remove('hidden');
            },

            renderEditArrowsRow() {
                const container = document.getElementById('edit-arrows-row');
                const { tempScores, currentArrowIdx } = this.editingCtx;
                
                container.innerHTML = tempScores.map((arrow, i) => {
                    const isSelected = i === currentArrowIdx;
                    const style = isSelected ? 'border-2 border-emerald-500 ring-2 ring-emerald-500/30 scale-110' : 'border border-slate-600 opacity-70';
                    const display = arrow ? (arrow.display || arrow.value) : '-';
                    const color = arrow ? arrow.color : 'bg-slate-800';
                    
                    return `
                        <div onclick="app.selectEditArrow(${i})" class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg cursor-pointer transition-all ${color} ${style}">
                            ${display}
                        </div>
                    `;
                }).join('');
            },

            selectEditArrow(idx) {
                this.editingCtx.currentArrowIdx = idx;
                this.renderEditArrowsRow();
            },

            applyEdit(keyObj) {
                const { currentArrowIdx, tempScores } = this.editingCtx;
                // Update temp array
                tempScores[currentArrowIdx] = { 
                    value: keyObj.value, 
                    display: keyObj.display || keyObj.label, 
                    color: keyObj.color 
                };
                
                // Auto-advance to next arrow if not last
                if (currentArrowIdx < this.data.arrowsPerEnd - 1) {
                    this.editingCtx.currentArrowIdx++;
                }
                
                this.renderEditArrowsRow();
            },

            saveEdits() {
                const { shooterIdx, endIdx, tempScores } = this.editingCtx;
                const finalScores = tempScores.filter(a => a !== null);
                
                this.data.shooters[shooterIdx].scores[endIdx] = finalScores;
                
                this.save();
                this.closeEditModal();
                this.renderScoreCardTable(shooterIdx);
                if ((endIdx + 1) === this.data.currentEnd && shooterIdx === this.data.currentShooterIndex) {
                    this.renderScoringUI();
                }
            },

            closeEditModal() { document.getElementById('edit-score-modal').classList.add('hidden'); },

            generateCSV() {
                const type = this.data.roundType;
                let csv = "";
                
                this.data.shooters.forEach((s, shooterIndex) => {
                    const className = s.classCode || s.class;
                    csv += `NAME: ${s.name}\n`;
                    csv += `CLASS: ${className}\n`;

                    // Dynamic Header based on type
                    let headerSuffix = "";
                    
                    if (type === 'vegas_330') headerSuffix = ",End 11s,End 10s";
                    else if (type === 'ifaa_360') headerSuffix = ",End 6s,End 5s";
                    else if (type === 'ibo') headerSuffix = ",End 11s"; // Correctly showing 11s
                    else if (type.includes('vegas')) headerSuffix = ",End Xs,End 10s";
                    else if (type.includes('ifaa')) headerSuffix = ",End Xs,End 5s";
                    else headerSuffix = ",End Xs";

                    csv += "End," + Array.from({length: this.data.arrowsPerEnd}, (_, i) => `Arrow ${i+1}`).join(',') + ",End Total,Running Total" + headerSuffix + "\n";
                    
                    let running = 0;
                    let countA = 0;
                    let countB = 0;
                    
                    s.scores.forEach((endArrows, idx) => {
                        const sortedArrows = [...endArrows].sort(this.sortArrows);
                        const vals = sortedArrows.map(a => a.display || a.value);
                        while(vals.length < this.data.arrowsPerEnd) vals.push('');
                        
                        const endSum = endArrows.reduce((x, y) => x + y.value, 0);
                        running += endSum;
                        
                        let endStat1 = 0;
                        let endStat2 = 0;

                        // Count Stats Logic for CSV
                        endArrows.forEach(a => {
                            const val = a.value;
                            const disp = a.display;

                            if (type === 'vegas_330') {
                                if (val === 11) endStat1++;
                                else if (val === 10) endStat2++;
                            } else if (type === 'ifaa_360') {
                                if (val === 6) endStat1++;
                                else if (val === 5) endStat2++;
                            } else if (type === 'ibo') {
                                if (val === 11) endStat1++;
                            } else if (type.includes('vegas')) {
                                if (disp === 'X') endStat1++;
                                else if (val === 10) endStat2++;
                            } else if (type.includes('ifaa')) {
                                if (disp === 'X') endStat1++;
                                else if (val === 5) endStat2++;
                            }
                        });
                        countA += endStat1;
                        countB += endStat2;
                        
                        let rowSuffix = "";
                        if (type === 'ibo') rowSuffix = `,${endStat1}`;
                        else rowSuffix = `,${endStat1},${endStat2}`;

                        csv += `${idx + 1},${vals.join(',')},${endSum},${running}${rowSuffix}\n`;
                    });

                    // Summary Row
                    const emptyCols = ",".repeat(this.data.arrowsPerEnd);
                    let statStr = "";
                    
                    if (type === 'vegas_330') statStr = `11s: ${countA} | 10s: ${countB}`;
                    else if (type === 'ifaa_360') statStr = `6s: ${countA} | 5s: ${countB}`;
                    else if (type === 'ibo') statStr = `11s: ${countA}`; // Correctly showing 11s
                    else if (type.includes('vegas')) statStr = `Xs: ${countA} | 10s: ${countB}`;
                    else if (type.includes('ifaa')) statStr = `Xs: ${countA} | 5s: ${countB}`;
                    else statStr = `Xs: ${countA}`;

                    csv += `TOTAL${emptyCols},,${running},${statStr}\n`;

                    if (shooterIndex < this.data.shooters.length - 1) {
                        csv += "\n\n";
                    }
                });
                return csv;
            },

            showToast(msg) {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerHTML = msg; // innerHTML for breaks
                t.classList.remove('translate-y-20', 'opacity-0', 'scale-90'); // Reset hidden state
                t.classList.add('scale-100'); // Show
                
                // Ensure pointer events remain none so clicks pass through
                t.classList.add('pointer-events-none'); 
                
                if(this.toastTimer) clearTimeout(this.toastTimer);
                
                this.toastTimer = setTimeout(() => {
                    this.hideToast();
                }, 5000);
            },
            
            hideToast() {
                const t = document.getElementById('toast');
                t.classList.remove('scale-100');
                t.classList.add('translate-y-20', 'opacity-0', 'scale-90');
            },

            copyToClipboard() {
                const csv = this.generateCSV();
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(csv).then(() => this.showToast("Copied Scorecards!")).catch(() => this.fallbackCopy(csv));
                } else {
                    this.fallbackCopy(csv);
                }
            },

            fallbackCopy(text) {
                const ta = document.getElementById('clipboard-target');
                ta.value = text;
                ta.select();
                try {
                    document.execCommand('copy');
                    this.showToast("Copied Scorecards!");
                } catch (e) {
                    this.showAlert("Copy failed. Please use 'Download CSV'.");
                }
            },

            downloadCSV() {
                const csv = this.generateCSV();
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `archery_scorecards_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                this.showToast("Downloading...");
            }
        };
        
        app.init();
    </script>
</body>
</html>