<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Archery Score Keeper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Mobile Viewport Fixes */
        html {
            height: 100%;
            overflow: hidden; 
        }
        body {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            overscroll-behavior-y: none;
            touch-action: manipulation;
            padding-bottom: env(safe-area-inset-bottom); 
            background-color: #0f172a; 
        }
        
        .btn-raised {
            transition: all 0.1s;
            border-bottom-width: 4px;
            border-color: rgba(0,0,0,0.3);
            filter: brightness(100%);
        }
        .btn-raised:active {
            transform: translateY(2px);
            border-bottom-width: 0px;
            margin-bottom: 4px; 
            filter: brightness(90%);
        }

        .animate-pop { animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .modal { transition: opacity 0.2s ease; }
        .modal-content { transition: transform 0.2s ease; }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .modal.hidden .modal-content { transform: scale(0.95); }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        select, input { appearance: none; }

        .toggle-checkbox:checked {
            right: 0;
            border-color: #10B981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10B981;
        }
    </style>
</head>
<body class="text-slate-100 flex flex-col font-sans">

    <!-- === Header === -->
    <header class="bg-slate-800 border-b border-slate-700 p-3 flex justify-between items-center z-10 shadow-md shrink-0 h-16">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-bullseye text-emerald-500 text-xl"></i>
            <div>
                <h1 class="font-bold text-lg tracking-wide leading-none">Archery<span class="text-emerald-500">Keeper</span></h1>
                <div class="text-[10px] text-slate-400 font-normal leading-none">by <span class="font-bold">Gary Hinshaw</span></div>
            </div>
        </div>
        <div class="flex gap-2">
            <button id="reorder-btn" onclick="app.openReorderModal()" class="text-slate-300 hover:text-white p-2 hidden" title="Reorder Shooters">
                <i class="fa-solid fa-arrow-down-short-wide text-xl"></i>
            </button>
            <button onclick="app.viewScoreCards()" class="text-slate-300 hover:text-white p-2" title="Scorecard">
                <i class="fa-solid fa-table-list text-xl"></i>
            </button>
            <button onclick="app.confirmReset()" class="text-slate-300 hover:text-red-400 p-2" title="Reset Round">
                <i class="fa-solid fa-rotate-right text-xl"></i>
            </button>
        </div>
    </header>

    <!-- === Main Content Area === -->
    <main id="main-container" class="flex-1 overflow-hidden relative w-full max-w-md mx-auto bg-slate-900 h-full">
        
        <!-- Screen 1: Setup -->
        <div id="setup-screen" class="h-full flex flex-col relative">
            <div class="flex-1 overflow-y-auto p-4 pb-48">
                <h2 class="text-xl font-bold mb-4 text-center text-emerald-400">Round Setup</h2>
                
                <!-- Round Type Selection -->
                <div class="mb-5 space-y-1 bg-slate-800/50 p-3 rounded-xl border border-emerald-900/50">
                    <label class="block text-sm font-bold text-emerald-400 uppercase tracking-wider mb-1">1. Select Round Type</label>
                    <select id="round-type" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-emerald-500 outline-none text-base font-bold" onchange="app.handleRoundTypeChange()">
                        <option value="" disabled selected>-- Please Select Round Type --</option>
                        <option value="ibo">3D / IBO (11-10-8-5-0)</option>
                        <option value="ifaa_300">IFAA 5-Spot 300</option>
                        <option value="ifaa_360">IFAA 5-Spot 360</option>
                        <option value="vegas_300">Vegas 3-Spot 300</option>
                        <option value="vegas_330">Vegas 3-Spot 330</option>
                        <option value="custom">Custom Round Builder...</option>
                    </select>
                </div>

                <!-- Custom Round Builder -->
                <div id="custom-builder" class="mb-5 hidden bg-slate-800/80 p-3 rounded-xl border border-blue-500/50">
                    <h3 class="font-bold text-blue-400 mb-2 text-sm uppercase">Custom Round</h3>
                    <div id="custom-segments-list" class="space-y-3 mb-3"></div>
                    <button onclick="app.addCustomSegment()" class="w-full py-2 bg-blue-600/20 hover:bg-blue-600/40 text-blue-300 border border-blue-500/50 rounded-lg text-sm font-bold">
                        + Add Another Target/Distance
                    </button>
                </div>

                <!-- Target Count -->
                <div id="target-count-container" class="mb-5 space-y-1 hidden">
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Number of Targets</label>
                    <div class="flex items-center bg-slate-800 rounded-lg border border-slate-600 p-1">
                        <button onclick="document.getElementById('target-count').stepDown()" class="p-3 text-slate-400 hover:text-white"><i class="fa-solid fa-minus"></i></button>
                        <input type="number" id="target-count" value="30" class="bg-transparent text-center w-full outline-none font-mono text-lg" min="1" max="100">
                        <button onclick="document.getElementById('target-count').stepUp()" class="p-3 text-slate-400 hover:text-white"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>

                <!-- Add Shooter Section -->
                <div class="mb-4 bg-slate-800/50 p-4 rounded-xl border border-slate-700/50">
                    <label class="block text-sm font-bold text-emerald-400 uppercase tracking-wider mb-3">2. Add Shooter</label>
                    
                    <div class="space-y-4">
                        <!-- Name Only -->
                        <div>
                            <input type="text" id="new-shooter-name" placeholder="Name" autocapitalize="words" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white outline-none focus:border-emerald-500 text-sm">
                        </div>

                        <!-- Fun Class Toggle -->
                        <div class="flex items-center justify-between bg-slate-700/50 p-3 rounded-lg border border-slate-600">
                            <span class="text-sm font-bold text-white"><i class="fa-solid fa-face-smile text-yellow-400 mr-2"></i>Fun Class</span>
                            <div class="relative inline-block w-12 h-6 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="fun-class-toggle" id="fun-class-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-600 transition-all duration-300 left-0" onchange="app.toggleFunClass('class-selector-container', this.checked)"/>
                                <label for="fun-class-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-600 cursor-pointer"></label>
                            </div>
                        </div>

                        <!-- Class Selection Container -->
                        <div id="class-selector-container">
                            <div class="p-2 text-center text-slate-500 text-sm italic border border-dashed border-slate-600 rounded-lg">Select Round Type first</div>
                        </div>

                        <button onclick="app.addShooter()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white p-3 rounded-lg font-bold shadow-lg active:scale-95 transition text-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-plus"></i> Add Shooter
                        </button>
                    </div>
                </div>
                    
                <!-- Shooter List -->
                <div id="shooter-list" class="space-y-2"></div>
            </div>

            <!-- Sticky Start Button -->
            <div class="absolute bottom-0 left-0 right-0 p-4 pb-24 bg-gradient-to-t from-slate-900 via-slate-900 to-transparent z-20">
                <button onclick="app.startRound()" class="w-full bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-bold py-3 rounded-xl text-lg shadow-xl shadow-emerald-900/30 active:scale-[0.98] transition">
                    START ROUND
                </button>
            </div>
        </div>

        <!-- Screen 2: Scoring -->
        <div id="scoring-screen" class="hidden h-full flex flex-col">
            
            <!-- Info Bar -->
            <div class="bg-slate-800/50 p-2 flex justify-between items-center text-xs sm:text-sm border-b border-slate-700 shrink-0 h-14">
                <span id="round-info-display" class="text-slate-400 truncate max-w-[120px]">Round</span>
                <span class="font-bold text-emerald-400 bg-emerald-900/30 px-3 py-1 rounded-full whitespace-nowrap text-lg shadow-lg border border-emerald-500/30">
                    End <span id="current-end-display">1</span> / <span id="total-ends-display">20</span>
                </span>
            </div>

            <!-- Custom Segment Info (if active) -->
            <div id="segment-info-bar" class="bg-blue-900/20 text-blue-300 text-xs text-center py-1 hidden border-b border-blue-900/30">
                <!-- Injected via JS -->
            </div>

            <!-- Shooter Tabs -->
            <div class="flex overflow-x-auto whitespace-nowrap bg-slate-800 p-1 scrollbar-hide shrink-0 h-12 items-center" id="shooter-tabs"></div>

            <!-- Main Scoring Area -->
            <div class="flex-1 flex flex-col p-3 min-h-0">
                <!-- Score Display -->
                <div class="bg-slate-800 rounded-2xl p-3 mb-2 shadow-lg border border-slate-700 shrink-0">
                    <div class="flex justify-between items-end mb-1">
                        <div>
                            <div class="text-slate-400 text-[10px] uppercase tracking-widest">Total</div>
                            <div class="text-3xl font-black text-white leading-tight" id="running-total">0</div>
                        </div>
                        <div class="text-right">
                            <div class="text-slate-400 text-[10px] uppercase tracking-widest">This End</div>
                            <div class="text-2xl font-bold text-emerald-400 leading-tight" id="end-total">0</div>
                        </div>
                    </div>
                    <!-- Halves Display -->
                    <div id="halves-display" class="flex justify-between text-xs text-slate-400 border-t border-slate-700/50 pt-2 pb-1">
                        <span>1st Half: <strong class="text-white text-sm" id="half1-total">0</strong></span>
                        <span>2nd Half: <strong class="text-white text-sm" id="half2-total">0</strong></span>
                    </div>
                    <div class="flex gap-1.5 mt-1 justify-center flex-wrap" id="arrow-slots"></div>
                </div>

                <!-- Controls -->
                <div class="flex justify-between items-center mb-2 px-1 shrink-0">
                    <button onclick="app.undoLastArrow()" class="bg-slate-700 hover:bg-slate-600 text-white border border-slate-500 px-6 h-14 rounded-xl font-bold shadow-md active:scale-95 transition text-lg flex items-center">
                        <i class="fa-solid fa-rotate-left mr-2"></i> Undo
                    </button>
                    <button onclick="app.nextShooterOrEnd()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 h-14 rounded-xl font-bold shadow-md active:scale-95 transition text-lg flex items-center">
                        Next <i class="fa-solid fa-chevron-right ml-2"></i>
                    </button>
                </div>

                <!-- Keypad -->
                <div id="keypad-container" class="flex-1 flex flex-col justify-center min-h-0 pb-safe">
                    <div class="grid gap-3 p-1" id="keypad"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- === Modals === -->

    <!-- Reorder Shooters Modal -->
    <div id="reorder-modal" class="modal hidden fixed inset-0 z-[80] bg-black/80 flex items-center justify-center p-4">
        <div class="modal-content bg-slate-800 p-5 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-600 flex flex-col max-h-[80vh]">
            <h4 class="text-xl font-bold mb-4 text-emerald-400 text-center">Change Order</h4>
            <div id="reorder-list" class="space-y-2 flex-1 overflow-y-auto mb-4">
                <!-- Filled via JS -->
            </div>
            <button onclick="app.closeReorderModal()" class="w-full py-3 bg-slate-700 rounded-lg text-white font-bold">Done</button>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notification-modal" class="modal hidden fixed inset-0 z-[80] bg-black/80 flex items-center justify-center p-4">
        <div class="modal-content bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-600 text-center">
            <h4 class="text-2xl font-bold mb-4 text-emerald-400">ArcheryKeeper</h4>
            <p id="notification-message" class="text-white mb-8 text-xl font-medium leading-relaxed"></p>
            <button onclick="app.closeNotification()" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold text-lg shadow-lg">OK</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal hidden fixed inset-0 z-[80] bg-black/80 flex items-center justify-center p-4">
        <div class="modal-content bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-600 text-center">
            <h4 class="text-xl font-bold mb-3 text-emerald-400">ArcheryKeeper</h4>
            <p id="confirmation-message" class="text-slate-300 mb-6 text-lg"></p>
            <div class="flex gap-3">
                <button onclick="app.closeConfirmation(false)" class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg font-bold">Cancel</button>
                <button onclick="app.closeConfirmation(true)" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold shadow-lg">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Scorecard Modal -->
    <div id="scorecard-modal" class="modal hidden fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-end sm:items-center justify-center">
        <div class="modal-content bg-slate-900 w-full sm:w-11/12 sm:max-w-xl h-[95dvh] sm:h-5/6 sm:rounded-2xl border-t sm:border border-slate-700 flex flex-col shadow-2xl">
            <div class="p-3 border-b border-slate-700 flex justify-between items-center bg-slate-800 sm:rounded-t-2xl shrink-0">
                <h3 class="font-bold text-lg text-emerald-400">Scorecard</h3>
                <button onclick="app.closeScoreCard()" class="w-8 h-8 rounded-full bg-slate-700 text-slate-300 flex items-center justify-center"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="flex-1 overflow-hidden flex flex-col">
                <div class="p-2 bg-slate-800/50 overflow-x-auto whitespace-nowrap shrink-0 border-b border-slate-700" id="modal-shooter-tabs"></div>
                <div class="flex-1 overflow-y-auto p-2">
                    <div id="scorecard-header-info" class="mb-2 p-2 bg-slate-800 rounded border border-slate-700 text-xs text-slate-300 flex justify-between items-center"></div>
                    <table class="w-full text-center border-collapse text-sm" id="scorecard-table"><thead id="scorecard-head"></thead><tbody id="scorecard-body"></tbody></table>
                </div>
            </div>
            <div class="p-3 pb-20 border-t border-slate-700 bg-slate-800 sm:rounded-b-2xl shrink-0 space-y-2">
                <div class="text-center text-xs text-slate-400 mb-1">Export Options</div>
                <div class="flex gap-2">
                    <button onclick="app.copyToClipboard()" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg font-bold text-sm"><i class="fa-regular fa-copy mr-2"></i> Copy to Share</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Score Modal -->
    <div id="edit-score-modal" class="modal hidden fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4">
        <div class="modal-content bg-slate-800 p-5 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-600 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-3">
                <h4 class="text-lg font-bold text-emerald-400">Correct Score</h4>
                <div class="text-sm text-slate-400" id="edit-score-context-header"></div>
            </div>
            <div id="edit-arrows-row" class="flex gap-2 justify-center mb-4 bg-slate-700/50 p-3 rounded-xl overflow-x-auto"></div>
            <div class="flex-1 overflow-y-auto mb-4"><div class="grid grid-cols-3 gap-2" id="edit-keypad"></div></div>
            <button onclick="app.saveEdits()" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold shadow-lg text-lg">Done</button>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal hidden fixed inset-0 z-[70] bg-black/80 flex items-center justify-center p-4">
        <div class="modal-content bg-slate-800 p-5 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-600">
            <h4 class="text-center text-lg font-bold mb-4 text-emerald-400">Edit Profile</h4>
            <div class="space-y-4 mb-4">
                <div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Name</label><input type="text" id="edit-profile-name" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white outline-none focus:border-emerald-500 text-sm" autocapitalize="words"></div>
                <div class="flex items-center justify-between bg-slate-700/50 p-2 rounded-lg border border-slate-600">
                    <span class="text-sm font-bold text-white">Fun Class</span>
                    <div class="relative inline-block w-12 h-6 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="edit-fun-toggle" id="edit-fun-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-600 transition-all duration-300 left-0" onchange="app.toggleFunClass('edit-class-container', this.checked)"/><label for="edit-fun-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-600 cursor-pointer"></label></div>
                </div>
                <div id="edit-class-container"></div>
            </div>
            <div class="flex gap-2"><button onclick="app.closeEditProfile()" class="flex-1 py-3 bg-slate-700 rounded-lg text-slate-300 font-bold">Cancel</button><button onclick="app.saveProfile()" class="flex-1 py-3 bg-emerald-600 text-white rounded-lg font-bold">Save</button></div>
        </div>
    </div>

    <textarea id="clipboard-target" class="fixed top-0 left-0 opacity-0 pointer-events-none"></textarea>
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-slate-800/95 border-2 border-emerald-500 text-white px-8 py-6 rounded-2xl shadow-2xl opacity-0 transition-all duration-300 pointer-events-none z-[90] text-center w-[90%] max-w-sm backdrop-blur-sm scale-90"><div id="toast-msg" class="text-2xl font-black tracking-wide text-emerald-400"></div></div>

    <script>
        const app = {
            data: {
                shooters: [],
                roundType: '', 
                customRound: null, 
                targetCount: 30, 
                arrowsPerEnd: 1, 
                currentEnd: 1,
                currentShooterIndex: 0,
                active: false,
                editingProfileId: null,
                confirmCallback: null,
                notificationCallback: null,
                autoAdvanceTimer: null,
                roundCompleteTimer: null,
                transitionTimer: null,
                isTransitioning: false 
            },

            // --- Static Data ---
            classes3D: ["Pee Wee (8 & under)", "Youth (9-12)", "Teen (13-17)", "Women's Barebow", "Women's Recurve", "Women's Longbow", "Men's Barebow", "Men's Recurve", "Men's Modern Recurve", "Men's Vintage Hunter", "Men's Modern Longbow", "Men's Longbow", "Men's Selfbow", "Senior"],
            ageMap: { "Cub (<12)": "C", "Youth (12-14)": "Y", "Young Adult (15-17)": "Y/A", "Adult (18-49)": "A", "Senior (50-59)": "S", "Silver Senior (60-69)": "S/S", "Master Senior (70+)": "M/S", "Professional": "Pro", "Professional Senior": "Pro Senior" },
            genderMap: { "Male": "M", "Female": "F" },
            styleMap: { "Freestyle (FS)": "FS", "Bowhunter Freestyle (BHFS)": "BHFS", "Freestyle Limited Recurve (FSLR)": "FSLR", "Barebow Recurve (BBR)": "BB", "Traditional (Trad)": "TRAD", "Freestyle Limited (FSL)": "FSL", "Barebow (BB)": "BB", "Longbow": "LB", "Bowhunter (BH)": "BH", "Bowhunter Freestyle Limited (BHFSL)": "BHFSL", "Crossbow (CB)": "CB" },
            ifaaGenders: ["Male", "Female"],
            ifaaAges: ["Cub (<12)", "Youth (12-14)", "Young Adult (15-17)", "Adult (18-49)", "Senior (50-59)", "Silver Senior (60-69)", "Master Senior (70+)", "Professional", "Professional Senior"],
            ifaaStyles: ["Freestyle (FS)", "Bowhunter Freestyle (BHFS)", "Freestyle Limited Recurve (FSLR)", "Barebow Recurve (BBR)", "Traditional (Trad)", "Freestyle Limited (FSL)", "Barebow (BB)", "Longbow", "Bowhunter (BH)", "Bowhunter Freestyle Limited (BHFSL)", "Crossbow (CB)"],

            // Pre-defined Configs
            configs: {
                ibo: { name: '3D (11-10-8-5-0)', arrows: 1, ends: 30, cols: 2, keys: [{ label: '11', value: 11, color: 'bg-orange-500' }, { label: '10', value: 10, color: 'bg-yellow-500 text-black' }, { label: '8', value: 8, color: 'bg-red-600' }, { label: '5', value: 5, color: 'bg-blue-600' }, { label: '0', value: 0, color: 'bg-gray-500 text-white', span: 'col-span-2' }] },
                ifaa_300: { name: 'IFAA 300', arrows: 5, ends: 12, cols: 3, keys: [{ label: 'X', value: 5, display: 'X', color: 'bg-slate-100 text-slate-900 border-4 border-blue-800' }, { label: '5', value: 5, color: 'bg-slate-100 text-slate-900' }, { label: '4', value: 4, color: 'bg-blue-700' }, { label: '3', value: 3, color: 'bg-blue-700' }, { label: '2', value: 2, color: 'bg-blue-700' }, { label: '1', value: 1, color: 'bg-blue-700' }, { label: '0', value: 0, color: 'bg-gray-500 text-white', span: 'col-span-3' }] },
                ifaa_360: { name: 'IFAA 360', arrows: 5, ends: 12, cols: 3, keys: [{ label: '6', value: 6, display: '6', color: 'bg-slate-100 text-slate-900 border-4 border-blue-800' }, { label: '5', value: 5, color: 'bg-slate-100 text-slate-900' }, { label: '4', value: 4, color: 'bg-blue-700' }, { label: '3', value: 3, color: 'bg-blue-700' }, { label: '2', value: 2, color: 'bg-blue-700' }, { label: '1', value: 1, color: 'bg-blue-700' }, { label: '0', value: 0, color: 'bg-gray-500 text-white', span: 'col-span-3' }] },
                vegas_300: { name: 'Vegas 300', arrows: 3, ends: 10, cols: 3, keys: [{ label: 'X', value: 10, display: 'X', color: 'bg-yellow-400 text-black border-2 border-black' }, { label: '10', value: 10, color: 'bg-yellow-400 text-black' }, { label: '9', value: 9, color: 'bg-yellow-400 text-black' }, { label: '8', value: 8, color: 'bg-red-600' }, { label: '7', value: 7, color: 'bg-red-600' }, { label: '6', value: 6, color: 'bg-blue-600' }, { label: '5', value: 5, color: 'bg-blue-600' }, { label: '4', value: 4, color: 'bg-slate-900 border border-slate-600' }, { label: '3', value: 3, color: 'bg-slate-900 border border-slate-600' }, { label: '2', value: 2, color: 'bg-slate-100 text-slate-900' }, { label: '1', value: 1, color: 'bg-slate-100 text-slate-900' }, { label: 'M', value: 0, color: 'bg-gray-500 text-white' }] },
                vegas_330: { name: 'Vegas 330', arrows: 3, ends: 10, cols: 3, keys: [{ label: '11', value: 11, display: '11', color: 'bg-yellow-400 text-black border-2 border-black' }, { label: '10', value: 10, color: 'bg-yellow-400 text-black' }, { label: '9', value: 9, color: 'bg-yellow-400 text-black' }, { label: '8', value: 8, color: 'bg-red-600' }, { label: '7', value: 7, color: 'bg-red-600' }, { label: '6', value: 6, color: 'bg-blue-600' }, { label: '5', value: 5, color: 'bg-blue-600' }, { label: '4', value: 4, color: 'bg-slate-900 border border-slate-600' }, { label: '3', value: 3, color: 'bg-slate-900 border border-slate-600' }, { label: '2', value: 2, color: 'bg-slate-100 text-slate-900' }, { label: '1', value: 1, color: 'bg-slate-100 text-slate-900' }, { label: 'M', value: 0, color: 'bg-gray-500 text-white' }] },
                full_11: { name: '11-0 Full', arrows: 3, ends: 10, cols: 3, keys: [
                    { label: '11', value: 11, color: 'bg-orange-500' }, { label: '10', value: 10, color: 'bg-yellow-500 text-black' }, { label: '9', value: 9, color: 'bg-yellow-400 text-black' },
                    { label: '8', value: 8, color: 'bg-red-600' }, { label: '7', value: 7, color: 'bg-red-600' }, { label: '6', value: 6, color: 'bg-blue-600' },
                    { label: '5', value: 5, color: 'bg-blue-600' }, { label: '4', value: 4, color: 'bg-black text-white' }, { label: '3', value: 3, color: 'bg-black text-white' },
                    { label: '2', value: 2, color: 'bg-white text-black border border-slate-400' }, { label: '1', value: 1, color: 'bg-white text-black border border-slate-400' }, { label: '0', value: 0, color: 'bg-gray-500 text-white' }
                ]}
            },
            
            customSegments: [], 
            
            init() {
                const saved = localStorage.getItem('archeryState_v20');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed.active) {
                            this.data = parsed;
                            this.showScreen('scoring');
                            this.renderScoringUI();
                            return;
                        }
                    } catch (e) { console.error("Save corrupted"); }
                }
                
                // Force reset the dropdown to default state to prevent browser caching previous selection
                const roundSelect = document.getElementById('round-type');
                if(roundSelect) roundSelect.value = "";
                
                this.showScreen('setup');
                this.handleRoundTypeChange(); 
            },

            save() { localStorage.setItem('archeryState_v20', JSON.stringify(this.data)); },
            formatName(str) { return str.toLowerCase().replace(/(?:^|[\s-])\w/g, function(match) { return match.toUpperCase(); }); },
            showAlert(msg, callback) { document.getElementById('notification-message').innerHTML = msg; this.notificationCallback = callback; document.getElementById('notification-modal').classList.remove('hidden'); },
            closeNotification() { document.getElementById('notification-modal').classList.add('hidden'); if (this.notificationCallback) { this.notificationCallback(); this.notificationCallback = null; } },
            showConfirm(msg, callback) { document.getElementById('confirmation-message').textContent = msg; this.confirmCallback = callback; document.getElementById('confirmation-modal').classList.remove('hidden'); },
            closeConfirmation(result) { document.getElementById('confirmation-modal').classList.add('hidden'); if (this.confirmCallback) this.confirmCallback(result); this.confirmCallback = null; },

            showScreen(screenId) {
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('scoring-screen').classList.add('hidden');
                document.getElementById(screenId + '-screen').classList.remove('hidden');
                if(screenId === 'scoring') document.getElementById('reorder-btn').classList.remove('hidden');
                else document.getElementById('reorder-btn').classList.add('hidden');
            },

            handleRoundTypeChange() {
                const type = document.getElementById('round-type').value;
                const targetCountDiv = document.getElementById('target-count-container');
                const customBuilder = document.getElementById('custom-builder');
                const classContainer = document.getElementById('class-selector-container');
                
                if (!type) {
                    targetCountDiv.classList.add('hidden');
                    customBuilder.classList.add('hidden');
                    classContainer.innerHTML = `<div class="p-2 text-center text-slate-500 text-sm italic border border-dashed border-slate-600 rounded-lg">Select Round Type above to see options</div>`;
                    return;
                }

                if (type === 'custom') {
                    targetCountDiv.classList.add('hidden');
                    customBuilder.classList.remove('hidden');
                    if (this.customSegments.length === 0) this.addCustomSegment();
                    this.renderCustomBuilder();
                } else {
                    targetCountDiv.classList.toggle('hidden', type !== 'ibo');
                    customBuilder.classList.add('hidden');
                }
                
                this.renderClassSelectors('class-selector-container', type);
            },

            addCustomSegment() {
                this.customSegments.push({
                    id: Date.now(),
                    name: `Target/Distance ${this.customSegments.length + 1}`,
                    totalArrows: '',
                    arrowsPerEnd: '',
                    scoringType: '', 
                    xValue: ''
                });
                this.renderCustomBuilder();
                if (this.customSegments.length === 1) this.renderClassSelectors('class-selector-container', 'custom');
            },
            removeCustomSegment(idx) { 
                this.customSegments.splice(idx, 1); 
                this.renderCustomBuilder(); 
                this.renderClassSelectors('class-selector-container', 'custom');
            },
            moveSegment(idx, dir) {
                if (idx + dir < 0 || idx + dir >= this.customSegments.length) return;
                const temp = this.customSegments[idx];
                this.customSegments[idx] = this.customSegments[idx + dir];
                this.customSegments[idx + dir] = temp;
                this.renderCustomBuilder();
                this.renderClassSelectors('class-selector-container', 'custom');
            },
            updateSegment(idx, field, val) {
                const seg = this.customSegments[idx];
                seg[field] = val;
                if (field === 'scoringType') {
                   if (val === 'ibo') seg.xValue = 11; 
                   else if (val === 'ifaa_360') seg.xValue = 6;
                   else if (val === 'vegas_300') seg.xValue = 10;
                   else if (val === 'ifaa_300') seg.xValue = 5;
                   else if (val === 'full_11') seg.xValue = 11;
                   if (idx === 0) this.renderClassSelectors('class-selector-container', 'custom');
                }
                this.renderCustomBuilder();
            },
            
            renderCustomBuilder() {
                const list = document.getElementById('custom-segments-list');
                list.innerHTML = this.customSegments.map((seg, i) => `
                    <div class="bg-slate-700/50 p-2 rounded-lg border border-slate-600 text-sm">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex gap-2">
                                <button onclick="app.moveSegment(${i}, -1)" class="p-1 hover:text-white"><i class="fa-solid fa-chevron-up"></i></button>
                                <button onclick="app.moveSegment(${i}, 1)" class="p-1 hover:text-white"><i class="fa-solid fa-chevron-down"></i></button>
                            </div>
                            <span class="font-bold text-blue-300">Target/Distance ${i+1}</span>
                            <button onclick="app.removeCustomSegment(${i})" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <input type="text" value="${seg.name}" onchange="app.updateSegment(${i}, 'name', this.value)" class="bg-slate-900 border border-slate-600 rounded p-1 text-white" placeholder="Target/Distance">
                            <select onchange="app.updateSegment(${i}, 'scoringType', this.value)" class="bg-slate-900 border border-slate-600 rounded p-1 text-white">
                                <option value="" disabled ${!seg.scoringType ? 'selected' : ''}>Choose Scoring Rules</option>
                                <option value="ibo" ${seg.scoringType === 'ibo' ? 'selected' : ''}>3D (11-10-8-5-0)</option>
                                <option value="full_11" ${seg.scoringType === 'full_11' ? 'selected' : ''}>11 - 0 (Sequential)</option>
                                <option value="vegas_300" ${seg.scoringType === 'vegas_300' ? 'selected' : ''}>10 - 0</option>
                                <option value="ifaa_360" ${seg.scoringType === 'ifaa_360' ? 'selected' : ''}>6 - 0</option>
                                <option value="ifaa_300" ${seg.scoringType === 'ifaa_300' ? 'selected' : ''}>5 - 0</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="text-xs text-slate-400">Total Arrows</label><input type="number" value="${seg.totalArrows}" placeholder="--" onchange="app.updateSegment(${i}, 'totalArrows', parseInt(this.value))" class="w-full bg-slate-900 border border-slate-600 rounded p-1 text-white"></div>
                            <div><label class="text-xs text-slate-400">Arr/End</label><input type="number" value="${seg.arrowsPerEnd}" placeholder="--" onchange="app.updateSegment(${i}, 'arrowsPerEnd', parseInt(this.value))" class="w-full bg-slate-900 border border-slate-600 rounded p-1 text-white"></div>
                        </div>
                        <div class="mt-2 pt-2 border-t border-slate-600/50 flex gap-2 items-center">
                            <span class="text-xs text-slate-400">X =</span>
                            <select onchange="app.updateSegment(${i}, 'xValue', parseInt(this.value))" class="w-20 bg-slate-900 border border-slate-600 rounded p-1 text-white">
                                <option value="" disabled ${!seg.xValue ? 'selected' : ''}>--</option>
                                <option value="11" ${seg.xValue === 11 ? 'selected' : ''}>11</option>
                                <option value="10" ${seg.xValue === 10 ? 'selected' : ''}>10</option>
                                <option value="6" ${seg.xValue === 6 ? 'selected' : ''}>6</option>
                                <option value="5" ${seg.xValue === 5 ? 'selected' : ''}>5</option>
                            </select>
                            <span class="text-xs text-slate-500 ml-auto">Ends: ${seg.totalArrows && seg.arrowsPerEnd ? Math.floor(seg.totalArrows / seg.arrowsPerEnd) : '--'}</span>
                        </div>
                    </div>
                `).join('');
            },

            renderClassSelectors(containerId, type) {
                const container = document.getElementById(containerId);
                if (!container || !type) return;
                
                let actualType = type;
                if (type === 'custom') {
                    if (this.customSegments.length > 0 && this.customSegments[0].scoringType === 'ibo') {
                        actualType = 'ibo';
                    } else {
                        actualType = 'ifaa_300';
                    }
                }
                
                const isFun = document.getElementById(containerId === 'class-selector-container' ? 'fun-class-toggle' : 'edit-fun-toggle')?.checked;
                let html = '';
                if (actualType === 'ibo') {
                    html = `<select class="class-input w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-white text-sm outline-none focus:border-emerald-500" ${isFun ? 'disabled' : ''}><option value="">Select Class...</option>${this.classes3D.map(c => `<option value="${c}">${c}</option>`).join('')}</select>`;
                } else {
                    html = `<div class="grid grid-cols-1 gap-2">
                        <select id="${containerId}-gender" class="class-input bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-white text-sm outline-none focus:border-emerald-500" ${isFun ? 'disabled' : ''}><option value="">Gender...</option>${this.ifaaGenders.map(g => `<option value="${g}">${g}</option>`).join('')}</select>
                        <select id="${containerId}-age" class="class-input bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-white text-sm outline-none focus:border-emerald-500" ${isFun ? 'disabled' : ''}><option value="">Age Group...</option>${this.ifaaAges.map(a => `<option value="${a}">${a}</option>`).join('')}</select>
                        <select id="${containerId}-style" class="class-input bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-white text-sm outline-none focus:border-emerald-500" ${isFun ? 'disabled' : ''}><option value="">Style...</option>${this.ifaaStyles.map(s => `<option value="${s}">${s}</option>`).join('')}</select>
                    </div>`;
                }
                container.innerHTML = html;
                if (isFun) container.querySelectorAll('select').forEach(el => el.classList.add('opacity-50'));
            },

            toggleFunClass(containerId, isChecked) {
                let type;
                if (containerId === 'class-selector-container') type = document.getElementById('round-type').value;
                else type = this.data.roundType;
                this.renderClassSelectors(containerId, type);
            },

            addShooter() {
                const nameInput = document.getElementById('new-shooter-name');
                const name = this.formatName(nameInput.value.trim());
                const isFun = document.getElementById('fun-class-toggle').checked;
                const type = document.getElementById('round-type').value;

                if (!type) return this.showAlert("Please select a Round Type first.");
                if (!name) return this.showAlert("Please enter a name");

                let shooterClass = "Fun Class", shooterCode = "FUN", parts = { isFun };
                let actualType = type;
                if (type === 'custom') {
                     if (this.customSegments.length > 0 && this.customSegments[0].scoringType === 'ibo') actualType = 'ibo';
                     else actualType = 'ifaa';
                }

                if (!isFun) {
                    if (actualType === 'ibo') {
                        const sel = document.querySelector('#class-selector-container select');
                        if (!sel.value) return this.showAlert("Select a class or choose Fun");
                        shooterClass = sel.value; shooterCode = sel.value; parts.selection = sel.value;
                    } else {
                        const g = document.getElementById('class-selector-container-gender').value;
                        const a = document.getElementById('class-selector-container-age').value;
                        const s = document.getElementById('class-selector-container-style').value;
                        if (!g || !a || !s) return this.showAlert("Select all options or choose Fun");
                        shooterClass = `${a} ${g} ${s}`;
                        shooterCode = `${this.ageMap[a]}-${this.genderMap[g]}-${this.styleMap[s]}`;
                        parts = { isFun: false, gender: g, age: a, style: s };
                    }
                }
                this.data.shooters.push({ id: Date.now(), name, class: shooterClass, classCode: shooterCode, classParts: parts, scores: [] });
                nameInput.value = '';
                document.getElementById('fun-class-toggle').checked = false;
                if (actualType === 'ibo') {
                     const sel = document.querySelector('#class-selector-container select');
                     if(sel) sel.value = "";
                } else {
                     document.getElementById('class-selector-container-gender').value = "";
                     document.getElementById('class-selector-container-age').value = "";
                     document.getElementById('class-selector-container-style').value = "";
                }
                this.toggleFunClass('class-selector-container', false);
                this.renderShooterList();
            },
            // ... Reorder/Edit logic ... 
            moveShooter(idx, dir) {
                if (idx + dir < 0 || idx + dir >= this.data.shooters.length) return;
                const temp = this.data.shooters[idx]; this.data.shooters[idx] = this.data.shooters[idx+dir]; this.data.shooters[idx+dir] = temp;
                if (this.data.active) {
                    if (this.data.currentShooterIndex === idx) this.data.currentShooterIndex += dir;
                    else if (this.data.currentShooterIndex === idx + dir) this.data.currentShooterIndex -= dir;
                    this.renderScoringUI(); this.renderReorderList(); 
                } else { this.renderShooterList(); }
            },
            openReorderModal() { this.renderReorderList(); document.getElementById('reorder-modal').classList.remove('hidden'); },
            closeReorderModal() { document.getElementById('reorder-modal').classList.add('hidden'); },
            renderReorderList() {
                const list = document.getElementById('reorder-list');
                list.innerHTML = this.data.shooters.map((s, i) => `
                    <div class="flex items-center justify-between bg-slate-700 p-3 rounded-lg border border-slate-600"><span class="font-bold text-white">${s.name}</span><div class="flex gap-2"><button onclick="app.moveShooter(${i}, -1)" class="p-2 bg-slate-600 rounded hover:bg-slate-500"><i class="fa-solid fa-chevron-up"></i></button><button onclick="app.moveShooter(${i}, 1)" class="p-2 bg-slate-600 rounded hover:bg-slate-500"><i class="fa-solid fa-chevron-down"></i></button></div></div>
                `).join('');
            },
            openEditProfile(index) {
                this.editingProfileIndex = index;
                const shooter = this.data.shooters[index];
                document.getElementById('edit-profile-name').value = shooter.name;
                const funToggle = document.getElementById('edit-fun-toggle');
                funToggle.checked = shooter.classParts?.isFun || false;
                this.renderClassSelectors('edit-class-container', this.data.roundType);
                let actualType = this.data.roundType;
                if (actualType === 'custom') { if (this.data.customRound.segments.length > 0 && this.data.customRound.segments[0].scoringType === 'ibo') actualType = 'ibo'; else actualType = 'ifaa'; }
                if (!funToggle.checked && shooter.classParts) {
                    if (actualType === 'ibo') {
                        const sel = document.querySelector('#edit-class-container select');
                        if(sel) sel.value = shooter.classParts.selection || "";
                    } else {
                        document.getElementById('edit-class-container-gender').value = shooter.classParts.gender || "";
                        document.getElementById('edit-class-container-age').value = shooter.classParts.age || "";
                        document.getElementById('edit-class-container-style').value = shooter.classParts.style || "";
                    }
                }
                document.getElementById('edit-profile-modal').classList.remove('hidden');
            },
            saveProfile() {
                const idx = this.editingProfileIndex;
                const name = this.formatName(document.getElementById('edit-profile-name').value.trim());
                const isFun = document.getElementById('edit-fun-toggle').checked;
                if (!name) return this.showAlert("Name required");
                let actualType = this.data.roundType;
                if (actualType === 'custom') { if (this.data.customRound.segments.length > 0 && this.data.customRound.segments[0].scoringType === 'ibo') actualType = 'ibo'; else actualType = 'ifaa'; }
                let shooterClass = "Fun Class", shooterCode = "FUN", parts = { isFun };
                if (!isFun) {
                     if (actualType === 'ibo') {
                        const sel = document.querySelector('#edit-class-container select');
                        if (!sel.value) return this.showAlert("Select a class or choose Fun");
                        shooterClass = sel.value; shooterCode = sel.value; parts.selection = sel.value;
                    } else {
                        const g = document.getElementById('edit-class-container-gender').value;
                        const a = document.getElementById('edit-class-container-age').value;
                        const s = document.getElementById('edit-class-container-style').value;
                        if (!g || !a || !s) return this.showAlert("Select all options or choose Fun");
                        shooterClass = `${a} ${g} ${s}`;
                        shooterCode = `${this.ageMap[a]}-${this.genderMap[g]}-${this.styleMap[s]}`;
                        parts = { isFun: false, gender: g, age: a, style: s };
                    }
                }
                this.data.shooters[idx].name = name;
                this.data.shooters[idx].class = shooterClass;
                this.data.shooters[idx].classCode = shooterCode;
                this.data.shooters[idx].classParts = parts;
                this.save();
                this.closeEditProfile();
                this.renderShooterList();
                this.renderScoringUI();
                if (!document.getElementById('scorecard-modal').classList.contains('hidden')) this.renderScoreCardTable(idx);
            },
            closeEditProfile() { document.getElementById('edit-profile-modal').classList.add('hidden'); },
            removeShooter(index) { this.data.shooters.splice(index, 1); this.renderShooterList(); },
            renderShooterList() {
                const list = document.getElementById('shooter-list');
                list.innerHTML = this.data.shooters.map((s, i) => `
                    <div class="flex items-center justify-between bg-slate-800 p-3 rounded-lg border border-slate-700 animate-pop">
                        <div class="flex-1 min-w-0 mr-2"><div class="font-bold text-sm truncate">${s.name}</div><div class="text-xs text-slate-400 truncate">${s.classCode}</div></div>
                        <div class="flex gap-1"><button onclick="app.moveShooter(${i}, -1)" class="text-slate-400 hover:text-white p-2 shrink-0"><i class="fa-solid fa-chevron-up"></i></button><button onclick="app.moveShooter(${i}, 1)" class="text-slate-400 hover:text-white p-2 shrink-0"><i class="fa-solid fa-chevron-down"></i></button><button onclick="app.openEditProfile(${i})" class="text-slate-400 hover:text-white p-2 shrink-0"><i class="fa-solid fa-pen-to-square"></i></button><button onclick="app.removeShooter(${i})" class="text-red-400 hover:text-red-300 p-2 shrink-0"><i class="fa-solid fa-trash"></i></button></div>
                    </div>
                `).join('');
            },

            confirmReset() { this.showConfirm("Reset current round? Data will be lost.", (yes) => { if (yes) { localStorage.removeItem('archeryState_v20'); location.reload(); } }); },

            startRound() {
                if (this.data.shooters.length === 0) return this.showAlert("Add a shooter first.");
                const type = document.getElementById('round-type').value;
                if (!type) return this.showAlert("Please select a Round Type.");

                this.data.roundType = type;
                if (type === 'custom') {
                    if (this.customSegments.length === 0) return this.showAlert("Add at least one target/distance.");
                    let totalEnds = 0;
                    for(let seg of this.customSegments) {
                        const ends = seg.totalArrows / seg.arrowsPerEnd;
                        if (!Number.isInteger(ends)) return this.showAlert(`Error in "${seg.name}": Total arrows must be divisible by Arrows/End.`);
                        seg.ends = ends;
                        totalEnds += ends;
                    }
                    this.data.customRound = { segments: JSON.parse(JSON.stringify(this.customSegments)) };
                    this.data.targetCount = totalEnds;
                } else {
                    const config = this.configs[type];
                    this.data.arrowsPerEnd = config.arrows;
                    this.data.targetCount = type === 'ibo' ? (parseInt(document.getElementById('target-count').value) || 30) : config.ends;
                }
                this.data.shooters.forEach(s => s.scores = Array(this.data.targetCount).fill(null).map(() => []));
                this.data.currentEnd = 1;
                this.data.currentShooterIndex = 0;
                this.data.active = true;
                this.save();
                this.showScreen('scoring');
                this.renderScoringUI();
            },

            getSegmentForEnd(endNum) {
                if (this.data.roundType !== 'custom') return null;
                let endsAccum = 0;
                for (let seg of this.data.customRound.segments) {
                    if (endNum <= endsAccum + seg.ends) {
                        return {
                            name: seg.name,
                            arrows: seg.arrowsPerEnd,
                            config: this.generateCustomConfig(seg),
                            segEnds: seg.ends,
                            currentSegEnd: endNum - endsAccum,
                            segTotalArrows: seg.totalArrows,
                            scoringType: seg.scoringType,
                            xValue: seg.xValue
                        };
                    }
                    endsAccum += seg.ends;
                }
                return null;
            },

            generateCustomConfig(seg) {
                let base = JSON.parse(JSON.stringify(this.configs[seg.scoringType]));
                if (base.keys && base.keys.length > 0) {
                    // Update label. If 11 or 6, use number. Else X.
                    if(seg.xValue === 11 || seg.xValue === 6) {
                        base.keys[0].label = seg.xValue.toString();
                        base.keys[0].display = seg.xValue.toString();
                    } else {
                        base.keys[0].label = "X";
                        base.keys[0].display = "X";
                    }
                    base.keys[0].value = seg.xValue;
                }
                base.arrows = seg.arrowsPerEnd;
                return base;
            },

            renderScoringUI() {
                let config;
                let arrowsCount;
                let segmentName = "";
                let segProgress = "";

                if (this.data.roundType === 'custom') {
                    const segInfo = this.getSegmentForEnd(this.data.currentEnd);
                    if (segInfo) {
                        config = segInfo.config;
                        arrowsCount = segInfo.arrows;
                        segmentName = segInfo.name;
                        segProgress = ` (${segInfo.currentSegEnd}/${segInfo.segEnds})`;
                    } else { config = this.configs['ibo']; arrowsCount = 1; }
                    document.getElementById('segment-info-bar').classList.remove('hidden');
                    document.getElementById('segment-info-bar').textContent = `${segmentName}${segProgress}`;
                    document.getElementById('round-info-display').textContent = "Custom";
                } else {
                    config = this.configs[this.data.roundType];
                    arrowsCount = this.data.arrowsPerEnd;
                    document.getElementById('round-info-display').textContent = config.name;
                    document.getElementById('segment-info-bar').classList.add('hidden');
                }
                this.data.runtimeArrowsPerEnd = arrowsCount;

                const shooter = this.data.shooters[this.data.currentShooterIndex];
                document.getElementById('current-end-display').textContent = this.data.currentEnd;
                document.getElementById('total-ends-display').textContent = this.data.targetCount;

                const tabs = document.getElementById('shooter-tabs');
                tabs.innerHTML = this.data.shooters.map((s, i) => `
                    <button onclick="app.switchShooter(${i})" class="${i === this.data.currentShooterIndex ? 'bg-emerald-600 text-white shadow-md' : 'bg-slate-700 text-slate-400'} px-4 py-2 rounded-lg mr-2 font-bold text-sm min-w-[100px] transition truncate max-w-[150px]">${s.name}</button>
                `).join('');
                setTimeout(() => tabs.children[this.data.currentShooterIndex]?.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }), 50);

                const currentScores = shooter.scores[this.data.currentEnd - 1] || [];
                const endTotal = currentScores.reduce((sum, a) => sum + a.value, 0);
                
                let runningTotal = 0; let half1Total = 0; let half2Total = 0;
                const halfEnds = Math.floor(this.data.targetCount / 2);

                shooter.scores.forEach((endArr, idx) => { 
                    if (endArr) {
                        const s = endArr.reduce((s, a) => s + a.value, 0);
                        runningTotal += s; 
                        if (idx < halfEnds) half1Total += s; else half2Total += s;
                    }
                });

                document.getElementById('end-total').textContent = endTotal;
                document.getElementById('running-total').textContent = runningTotal;
                if (this.data.roundType !== 'custom' && this.data.roundType !== 'ibo') {
                    document.getElementById('halves-display').classList.remove('hidden');
                    document.getElementById('half1-total').textContent = half1Total;
                    document.getElementById('half2-total').textContent = half2Total;
                } else { document.getElementById('halves-display').classList.add('hidden'); }

                const slots = document.getElementById('arrow-slots');
                let slotsHtml = '';
                for (let i = 0; i < arrowsCount; i++) {
                    const arrow = currentScores[i];
                    slotsHtml += arrow ? `<div class="w-10 h-10 flex items-center justify-center rounded-full text-sm font-bold shadow-inner ${arrow.color} animate-pop border border-slate-700">${arrow.display || arrow.value}</div>` : `<div class="w-10 h-10 rounded-full border border-dashed border-slate-600 bg-slate-800/50"></div>`;
                }
                slots.innerHTML = slotsHtml;

                const keypad = document.getElementById('keypad');
                keypad.className = `grid gap-3 p-1 pb-4 grid-cols-${config.cols || 3}`;
                keypad.innerHTML = config.keys.map(k => `
                    <button onclick='app.addScore(${JSON.stringify(k)})' class="btn-raised ${k.color} ${k.span || ''} h-20 rounded-2xl text-2xl font-black shadow-lg flex items-center justify-center relative overflow-hidden active:scale-95 transition-transform duration-75">${k.label}</button>
                `).join('');
            },

            addScore(keyObj) {
                const shooter = this.data.shooters[this.data.currentShooterIndex];
                const endIdx = this.data.currentEnd - 1;
                const arrowsLimit = this.data.runtimeArrowsPerEnd || this.data.arrowsPerEnd;

                if (!shooter.scores[endIdx]) shooter.scores[endIdx] = [];
                if (shooter.scores[endIdx].length < arrowsLimit) {
                    shooter.scores[endIdx].push({ value: keyObj.value, display: keyObj.display || keyObj.label, color: keyObj.color });
                    this.save();
                    this.renderScoringUI();
                    
                    const isLastShooter = this.data.currentShooterIndex === this.data.shooters.length - 1;
                    const isEndComplete = shooter.scores[endIdx].length === arrowsLimit;
                    
                    if (isLastShooter && isEndComplete) {
                        if (this.data.currentEnd === this.data.targetCount) {
                             this.data.roundCompleteTimer = setTimeout(() => {
                                this.data.roundCompleteTimer = null;
                                this.showAlert("Round Complete!", () => { this.viewScoreCards(); });
                            }, 2000);
                             return;
                        }

                        let interruptionMsg = null;
                        if (this.data.roundType === 'custom') {
                            let accum = 0;
                            // Check Multi-Segment completion
                            for (let i = 0; i < this.data.customRound.segments.length; i++) {
                                accum += this.data.customRound.segments[i].ends;
                                if (this.data.currentEnd === accum) {
                                    // Segment i complete.
                                    const roundNum = i + 1;
                                    const ordinal = (n) => n + (n > 0 ? ['th', 'st', 'nd', 'rd'][(n > 3 && n < 21) || n % 10 > 3 ? 0 : n % 10] : '');
                                    const nextSeg = this.data.customRound.segments[i+1];
                                    
                                    interruptionMsg = `<span class='text-xl font-bold'>${ordinal(roundNum)} Round Complete</span>`;
                                    if(nextSeg) interruptionMsg += `<br><br>Next: ${nextSeg.name}<br><span class="text-sm text-slate-400">Change Target/Distance</span>`;
                                    break;
                                }
                            }
                        } else if (this.data.roundType !== 'ibo') {
                            const halfEnds = Math.floor(this.data.targetCount / 2);
                            if (this.data.currentEnd === halfEnds) {
                                interruptionMsg = `<span class='text-3xl font-bold leading-relaxed'>Halfway - Switch Targets</span>`;
                            }
                        }

                        if (interruptionMsg) {
                            this.data.transitionTimer = setTimeout(() => {
                                this.data.transitionTimer = null;
                                this.showAlert(interruptionMsg, () => { this.nextShooterOrEnd(); });
                            }, 300);
                        } else {
                            this.showToast(`End ${this.data.currentEnd} Complete.<br>Advancing...`);
                            this.data.autoAdvanceTimer = setTimeout(() => {
                                this.data.autoAdvanceTimer = null;
                                this.hideToast();
                                this.nextShooterOrEnd();
                            }, 5000);
                        }
                    }
                }
            },

            undoLastArrow() {
                const shooter = this.data.shooters[this.data.currentShooterIndex];
                const endIdx = this.data.currentEnd - 1;
                if (shooter.scores[endIdx] && shooter.scores[endIdx].length > 0) {
                    shooter.scores[endIdx].pop();
                    this.save();
                    this.renderScoringUI();
                }
            },

            switchShooter(index) {
                this.data.currentShooterIndex = index;
                this.renderScoringUI();
            },

            nextShooterOrEnd() {
                if (this.data.isTransitioning) return;
                if (this.data.transitionTimer) { clearTimeout(this.data.transitionTimer); this.data.transitionTimer = null; }
                if (this.data.autoAdvanceTimer) { clearTimeout(this.data.autoAdvanceTimer); this.data.autoAdvanceTimer = null; this.hideToast(); }
                if (this.data.roundCompleteTimer) { clearTimeout(this.data.roundCompleteTimer); this.data.roundCompleteTimer = null; this.showAlert("Round Complete!", () => { this.viewScoreCards(); }); return; }

                const currentShooter = this.data.shooters[this.data.currentShooterIndex];
                const endIdx = this.data.currentEnd - 1;
                const arrowsLimit = this.data.runtimeArrowsPerEnd || this.data.arrowsPerEnd;
                
                if (currentShooter.scores[endIdx].length < arrowsLimit) return this.showAlert("Finish shooting this end first.");
                
                this.data.isTransitioning = true;
                setTimeout(() => { this.data.isTransitioning = false; }, 500);

                if (this.data.currentShooterIndex < this.data.shooters.length - 1) {
                    this.data.currentShooterIndex++;
                } else {
                    if (this.data.currentEnd < this.data.targetCount) {
                        this.data.currentEnd++;
                        this.data.currentShooterIndex = 0;
                    } else {
                        this.viewScoreCards();
                        return;
                    }
                }
                this.save();
                this.renderScoringUI();
            },

            viewScoreCards() {
                if (!this.data.active) return;
                const modalTabs = document.getElementById('modal-shooter-tabs');
                modalTabs.innerHTML = this.data.shooters.map((s, i) => `
                    <button onclick="app.renderScoreCardTable(${i})" class="modal-tab-btn px-4 py-2 mr-2 rounded-full text-xs font-bold border ${i === this.data.currentShooterIndex ? 'border-emerald-500 bg-emerald-600 text-white' : 'border-slate-600 bg-slate-700 text-slate-300'}">${s.name}</button>
                `).join('');
                this.renderScoreCardTable(this.data.currentShooterIndex);
                document.getElementById('scorecard-modal').classList.remove('hidden');
            },

            sortArrows(a, b) {
                if (a.value !== b.value) return b.value - a.value;
                if (a.display === 'X' && b.display !== 'X') return -1;
                if (b.display === 'X' && a.display !== 'X') return 1;
                return 0;
            },

            renderScoreCardTable(shooterIdx) {
                const shooter = this.data.shooters[shooterIdx];
                const tbody = document.getElementById('scorecard-body');
                const thead = document.getElementById('scorecard-head');
                const headerInfo = document.getElementById('scorecard-header-info');
                const type = this.data.roundType;
                
                headerInfo.innerHTML = `<div><div class="font-bold text-sm text-emerald-400">${shooter.name}</div><div class="text-xs">Class: ${shooter.classCode || shooter.class}</div></div><button onclick="app.openEditProfile(${shooterIdx})" class="p-2 text-slate-400 hover:text-white"><i class="fa-solid fa-pen-to-square"></i></button>`;

                let stat1Label = "X", stat2Label = "", hasStat2 = false;

                if (type === 'vegas_330') { stat1Label = "11"; stat2Label = "10"; hasStat2 = true; }
                else if (type === 'ifaa_360') { stat1Label = "6"; stat2Label = "5"; hasStat2 = true; }
                else if (type === 'ibo') { stat1Label = "11"; hasStat2 = false; }
                else if (type.includes('vegas')) { stat1Label = "X"; stat2Label = "10"; hasStat2 = true; }
                else if (type.includes('ifaa')) { stat1Label = "X"; stat2Label = "5"; hasStat2 = true; }
                else if (type === 'custom') { 
                    const seg = this.data.customRound.segments[0];
                    stat1Label = seg.xValue.toString();
                    if(seg.xValue === 10 || seg.xValue === 5) stat1Label = "X"; 
                    
                    if (seg.scoringType !== 'ibo') {
                        hasStat2 = true;
                        if (seg.scoringType.includes('vegas') || seg.scoringType === 'full_11') stat2Label = "10";
                        else if (seg.scoringType.includes('ifaa')) stat2Label = "5";
                    } else { hasStat2 = false; }
                }

                let headerHtml = `<tr class="text-slate-400 text-xs uppercase bg-slate-800 sticky top-0 z-10 shadow-sm"><th class="p-2">End</th><th class="p-2">Arrows</th><th class="p-2">Score</th><th class="p-2">${stat1Label}</th>${hasStat2 ? `<th class="p-2">${stat2Label}</th>` : ''}<th class="p-2">Run</th></tr>`;
                thead.innerHTML = headerHtml;

                let runningTotal = 0, half1Total = 0, half2Total = 0, grandStat1 = 0, grandStat2 = 0, html = '';
                const halfEnds = Math.floor(this.data.targetCount / 2);
                const colSpan = hasStat2 ? 6 : 5;
                const docButtons = document.querySelectorAll('.modal-tab-btn');
                if(docButtons) docButtons.forEach((btn, i) => { if(i===shooterIdx) btn.className = "modal-tab-btn px-4 py-2 mr-2 rounded-full text-xs font-bold border border-emerald-500 bg-emerald-600 text-white"; else btn.className = "modal-tab-btn px-4 py-2 mr-2 rounded-full text-xs font-bold border border-slate-600 bg-slate-700 text-slate-300"; });

                for (let i = 0; i < this.data.targetCount; i++) {
                    const arrows = shooter.scores[i] || [];
                    const endSum = arrows.reduce((a, b) => a + b.value, 0);
                    let endStat1 = 0, endStat2 = 0;
                    
                    let segArrows = this.data.arrowsPerEnd;
                    if(type==='custom') { const seg = this.getSegmentForEnd(i+1); if(seg) segArrows = seg.arrows; }

                    if (arrows.length > 0) {
                        runningTotal += endSum;
                        if (i < halfEnds) half1Total += endSum; else half2Total += endSum;
                        
                        arrows.forEach(a => {
                            const val = a.value; const disp = a.display;
                            if (type === 'vegas_330') { if (val === 11) endStat1++; else if (val === 10) endStat2++; } 
                            else if (type === 'ifaa_360') { if (val === 6) endStat1++; else if (val === 5) endStat2++; } 
                            else if (type === 'ibo') { if (val === 11) endStat1++; }
                            else if (type === 'custom') { 
                                const seg = this.getSegmentForEnd(i+1);
                                if(seg) {
                                    if(val === seg.xValue || disp === 'X') endStat1++;
                                    // Custom Stat 2 logic
                                    if(seg.scoringType !== 'ibo') {
                                        if(seg.scoringType.includes('vegas') && val===10 && disp!=='X') endStat2++;
                                        else if(seg.scoringType.includes('ifaa') && val===5 && disp!=='X') endStat2++;
                                        else if(seg.scoringType === 'full_11' && val===10) endStat2++;
                                    }
                                }
                            }
                            else if (type.includes('vegas')) { if (disp === 'X') endStat1++; else if (val === 10) endStat2++; }
                            else if (type.includes('ifaa')) { if (disp === 'X') endStat1++; else if (val === 5) endStat2++; }
                        });
                        grandStat1 += endStat1; grandStat2 += endStat2;
                    }
                    
                    const sortedArrows = [...arrows].sort(this.sortArrows);
                    let arrowCells = '';
                    for (let j = 0; j < segArrows; j++) {
                        if (sortedArrows[j]) {
                            const originalIdx = arrows.indexOf(sortedArrows[j]);
                            arrowCells += `<span onclick="app.openEditModal(${shooterIdx}, ${i}, ${originalIdx})" class="inline-block w-6 h-6 leading-6 text-center rounded-full ${sortedArrows[j].color} text-[10px] font-bold mx-0.5 shadow-sm border border-black/20">${sortedArrows[j].display || sortedArrows[j].value}</span>`;
                        } else {
                            arrowCells += `<span class="inline-block w-6 h-6 leading-6 text-center rounded-full bg-slate-900 text-slate-600 text-[10px] mx-0.5">-</span>`;
                        }
                    }
                    html += `<tr class="border-b border-slate-700 ${i % 2 === 0 ? 'bg-slate-800' : 'bg-slate-800/50'}"><td class="p-2 text-slate-400 font-mono">${i + 1}</td><td class="p-2 whitespace-nowrap">${arrowCells}</td><td class="p-2 text-emerald-400 font-bold">${arrows.length ? endSum : '-'}</td><td class="p-2 text-xs font-bold text-slate-300">${endStat1 || '-'}</td>${hasStat2 ? `<td class="p-2 text-xs font-bold text-slate-300">${endStat2 || '-'}</td>` : ''}<td class="p-2 font-bold">${arrows.length ? runningTotal : '-'}</td></tr>`;
                    if (i === halfEnds - 1 && type !== 'custom' && type !== 'ibo') { html += `<tr class="bg-slate-700 border-y-2 border-slate-600"><td colspan="2" class="p-2 text-right text-slate-300 text-xs font-bold uppercase">1st Half Total</td><td colspan="${colSpan-2}" class="p-2 text-lg font-bold text-white text-right">${half1Total}</td></tr>`; }
                }
                
                if(type !== 'custom' && type !== 'ibo') html += `<tr class="bg-slate-700 border-b border-slate-600"><td colspan="2" class="p-2 text-right text-slate-300 text-xs font-bold uppercase">2nd Half Total</td><td colspan="${colSpan-2}" class="p-2 text-lg font-bold text-white text-right">${half2Total}</td></tr>`;
                let footerStats = hasStat2 ? `${stat1Label}s: ${grandStat1} | ${stat2Label}s: ${grandStat2}` : `${stat1Label}s: ${grandStat1}`;
                html += `<tr class="bg-slate-900 border-t-2 border-emerald-600"><td colspan="3" class="p-3 text-left pl-4"><span class="text-slate-400 text-xs font-bold uppercase mr-2">Stats</span><span class="text-md font-bold text-white">${footerStats}</span></td><td colspan="${colSpan-3}" class="p-3 text-right"><span class="text-emerald-500 text-xs font-bold uppercase mr-2">Total</span><span class="text-2xl font-black text-white">${runningTotal}</span></td></tr>`;
                tbody.innerHTML = html;
            },

            closeScoreCard() { document.getElementById('scorecard-modal').classList.add('hidden'); },

            openEditModal(shooterIdx, endIdx, arrowIdx) {
                this.editingCtx = { shooterIdx, endIdx, currentArrowIdx: arrowIdx, tempScores: [] };
                const shooter = this.data.shooters[shooterIdx];
                const existing = shooter.scores[endIdx] || [];
                let limit = this.data.arrowsPerEnd;
                let config = this.configs[this.data.roundType];
                if(this.data.roundType === 'custom') { const seg = this.getSegmentForEnd(endIdx+1); limit = seg.arrows; config = seg.config; }
                this.editingCtx.tempScores = Array.from({length: limit}, (_, i) => existing[i] || null);
                const contextDiv = document.getElementById('edit-score-context-header');
                contextDiv.innerHTML = `${shooter.name} - End ${endIdx + 1}`;
                this.renderEditArrowsRow();
                document.getElementById('edit-keypad').innerHTML = config.keys.map(k => `<button onclick='app.applyEdit(${JSON.stringify(k)})' class="btn-raised ${k.color} h-12 rounded-lg text-lg font-bold shadow-md">${k.label}</button>`).join('');
                document.getElementById('edit-score-modal').classList.remove('hidden');
            },

            renderEditArrowsRow() {
                const container = document.getElementById('edit-arrows-row');
                const { tempScores, currentArrowIdx } = this.editingCtx;
                container.innerHTML = tempScores.map((arrow, i) => {
                    const isSelected = i === currentArrowIdx;
                    const style = isSelected ? 'border-2 border-emerald-500 ring-2 ring-emerald-500/30 scale-110' : 'border border-slate-600 opacity-70';
                    const display = arrow ? (arrow.display || arrow.value) : '-';
                    const color = arrow ? arrow.color : 'bg-slate-800';
                    return `<div onclick="app.selectEditArrow(${i})" class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg cursor-pointer transition-all ${color} ${style}">${display}</div>`;
                }).join('');
            },

            selectEditArrow(idx) { this.editingCtx.currentArrowIdx = idx; this.renderEditArrowsRow(); },

            applyEdit(keyObj) {
                const { currentArrowIdx, tempScores } = this.editingCtx;
                tempScores[currentArrowIdx] = { value: keyObj.value, display: keyObj.display || keyObj.label, color: keyObj.color };
                if (currentArrowIdx < tempScores.length - 1) this.editingCtx.currentArrowIdx++;
                this.renderEditArrowsRow();
            },

            saveEdits() {
                const { shooterIdx, endIdx, tempScores } = this.editingCtx;
                const finalScores = tempScores.filter(a => a !== null);
                this.data.shooters[shooterIdx].scores[endIdx] = finalScores;
                this.save();
                this.closeEditModal();
                this.renderScoreCardTable(shooterIdx);
                if ((endIdx + 1) === this.data.currentEnd && shooterIdx === this.data.currentShooterIndex) { this.renderScoringUI(); }
            },

            closeEditModal() { document.getElementById('edit-score-modal').classList.add('hidden'); },

            generateCSV() {
                const type = this.data.roundType;
                let csv = "";
                
                this.data.shooters.forEach((s, shooterIndex) => {
                    const className = s.classCode || s.class;
                    csv += `NAME: ${s.name}\n`;
                    csv += `CLASS: ${className}\n`;

                    // Determine formatting vars based on round type
                    let headerSuffix = "";
                    // Use the configured arrowsPerEnd for this specific shooter/round instance
                    // Fallback to data.arrowsPerEnd if not found
                    let arrowColCount = this.data.arrowsPerEnd;

                    if (type === 'custom') {
                        // For custom, try to find max arrows to ensure enough columns
                        if(this.data.customRound && this.data.customRound.segments) {
                             arrowColCount = this.data.customRound.segments.reduce((max, seg) => Math.max(max, seg.arrowsPerEnd), 0);
                        }
                        
                        const seg = this.data.customRound.segments[0];
                        const label1 = seg.xValue.toString();
                        let realLabel1 = label1;
                        if(seg.xValue === 10 || seg.xValue === 5) realLabel1 = "X";

                        if(seg.scoringType !== 'ibo') {
                             const label2 = (seg.scoringType.includes('vegas') || seg.scoringType === 'full_11') ? "10s" : "5s";
                             headerSuffix = `,End ${realLabel1}s,End ${label2}`;
                        } else {
                             headerSuffix = `,End ${realLabel1}s`;
                        }
                    }
                    else if (type === 'vegas_330') headerSuffix = ",End 11s,End 10s";
                    else if (type === 'ifaa_360') headerSuffix = ",End 6s,End 5s";
                    else if (type === 'ibo') headerSuffix = ",End 11s";
                    else if (type.includes('vegas')) headerSuffix = ",End Xs,End 10s";
                    else if (type.includes('ifaa')) headerSuffix = ",End Xs,End 5s";
                    else headerSuffix = ",End Xs";

                    // Build Header Row
                    csv += "End," + Array.from({length: arrowColCount}, (_, i) => `Arrow ${i+1}`).join(',') + ",End Total,Running Total" + headerSuffix + "\n";
                    
                    let running = 0;
                    let countA = 0;
                    let countB = 0;
                    
                    s.scores.forEach((endArrows, idx) => {
                        const sortedArrows = [...endArrows].sort(this.sortArrows);
                        const vals = sortedArrows.map(a => a.display || a.value);
                        
                        // Pad arrow columns to match header exactly
                        while(vals.length < arrowColCount) vals.push(''); 
                        
                        const endSum = endArrows.reduce((x, y) => x + y.value, 0);
                        running += endSum;
                        
                        let endStat1 = 0;
                        let endStat2 = 0;

                        // Count Stats Logic
                        endArrows.forEach(a => {
                            const val = a.value; const disp = a.display;
                            if (type === 'vegas_330') { if (val === 11) endStat1++; else if (val === 10) endStat2++; } 
                            else if (type === 'ifaa_360') { if (val === 6) endStat1++; else if (val === 5) endStat2++; } 
                            else if (type === 'ibo') { if (val === 11) endStat1++; }
                            else if (type === 'custom') { 
                                const seg = this.getSegmentForEnd(idx+1);
                                if(seg) {
                                    if(val === seg.xValue || disp === 'X') endStat1++;
                                    if(seg.scoringType !== 'ibo') {
                                         if(seg.scoringType.includes('vegas') && val===10 && disp!=='X') endStat2++;
                                         else if(seg.scoringType.includes('ifaa') && val===5 && disp!=='X') endStat2++;
                                         else if(seg.scoringType === 'full_11' && val===10) endStat2++;
                                    }
                                }
                            }
                            else if (type.includes('vegas')) { if (disp === 'X') endStat1++; else if (val === 10) endStat2++; }
                            else if (type.includes('ifaa')) { if (disp === 'X') endStat1++; else if (val === 5) endStat2++; }
                        });
                        countA += endStat1;
                        countB += endStat2;
                        
                        let rowSuffix = "";
                        // Logic to match header columns count
                        // If header has 2 stat columns, we must provide 2 stat values, even if one is empty/zero
                        const hasTwoStats = headerSuffix.split(',').length === 3; // ",Stat1,Stat2" = 3 parts (empty, S1, S2)
                        
                        if (hasTwoStats) rowSuffix = `,${endStat1},${endStat2}`;
                        else rowSuffix = `,${endStat1}`;

                        csv += `${idx + 1},${vals.join(',')},${endSum},${running}${rowSuffix}\n`;
                    });

                    // Summary Row
                    // We need empty columns for: End + Arrows... + End Total
                    // Count = 1 + arrowColCount + 1
                    const emptyColCount = 1 + arrowColCount + 1;
                    const emptyCols = ",".repeat(emptyColCount); 
                    
                    let statPart = "";
                    const hasTwoStats = headerSuffix.split(',').length === 3;
                    
                    if (hasTwoStats) statPart = `,${countA},${countB}`;
                    else statPart = `,${countA}`;

                    // Format: TOTAL, [empty...], RunningTotal, Stat1, Stat2
                    // Since "TOTAL" takes the "End" column, we need emptyCols starting from Arrow 1.
                    // Actually, simplest way is manual commas:
                    // Col 1: TOTAL
                    // Col 2..N: Arrows (arrowColCount)
                    // Col N+1: End Total
                    // Col N+2: Running Total (Value)
                    // Col N+3...: Stats
                    
                    const filler = ",".repeat(arrowColCount + 1); // Arrows cols + EndTotal col

                    csv += `TOTAL${filler},${running}${statPart}\n`;

                    if (shooterIndex < this.data.shooters.length - 1) {
                        csv += "\n\n";
                    }
                });
                return csv;
            },

            showToast(msg) {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerHTML = msg;
                t.classList.remove('translate-y-20', 'opacity-0', 'scale-90');
                t.classList.add('scale-100');
                t.classList.add('pointer-events-none');
                if(this.toastTimer) clearTimeout(this.toastTimer);
                this.toastTimer = setTimeout(() => { this.hideToast(); }, 5000);
            },
            hideToast() { const t = document.getElementById('toast'); t.classList.remove('scale-100'); t.classList.add('translate-y-20', 'opacity-0', 'scale-90'); },
            copyToClipboard() { const csv = this.generateCSV(); if (navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(csv).then(() => this.showToast("Copied Scorecards!")).catch(() => this.fallbackCopy(csv)); } else { this.fallbackCopy(csv); } },
            fallbackCopy(text) { const ta = document.getElementById('clipboard-target'); ta.value = text; ta.select(); try { document.execCommand('copy'); this.showToast("Copied Scorecards!"); } catch (e) { this.showAlert("Copy failed. Please use 'Download CSV'."); } },
            downloadCSV() {
                const csv = this.generateCSV();
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `archery_scorecards_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                this.showToast("Downloading...");
            }
        };
        app.init();
    </script>
</body>
</html>